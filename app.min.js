document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("drop-zone"),t=document.getElementById("file-input"),n=document.getElementById("page-list"),a=document.getElementById("content-section"),o=document.getElementById("canvas-container"),s=document.getElementById("canvas"),r=s.getContext("2d"),i=document.getElementById("selection-bar"),l=document.getElementById("min-thumb"),c=document.getElementById("max-thumb"),d=(document.getElementById("title-bar"),document.getElementById("document-title")),u=document.getElementById("load-button"),p=document.getElementById("save-button"),h=document.getElementById("login-button"),m=document.getElementById("user-menu"),f=document.getElementById("user-avatar"),g=document.getElementById("user-dropdown"),y=document.getElementById("switch-user-button"),w=document.getElementById("logout-button"),v=document.getElementById("notification-area");let E;function b(e,t=3e3){v.textContent=e,v.style.display="block",clearTimeout(E),E=setTimeout(()=>{v.style.display="none"},t)}const L=[];let x=-1,C=0,D=0;function k(e){if(0===e.length)return;const t=Array.from(e).map(e=>new Promise((t,n)=>{const a=new FileReader;a.onload=n=>{const a=n.target.result;if(a.byteLength<A)return console.error(`File ${e.name} is smaller than the minimum header size.`),t(null);L.push({name:e.name,rawData:a,paths:null}),t(!0)},a.onerror=e=>n(e),a.readAsArrayBuffer(e)}));Promise.all(t).then(()=>{P(),-1===x&&L.length>0?M(0):M(x)})}e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");k(t.dataTransfer.files)}),t.addEventListener("change",e=>{k(e.target.files)});const A=32,U=6,I=12e3;function B(e){if(e.paths)return;const t=new DataView(e.rawData),n=[];let a=[],o=-1;for(let e=A;e+U<=t.byteLength;e+=U){-1===o&&(o=e);const s=t.getUint8(e),r=t.getInt16(e+1,!0),i=t.getInt16(e+3,!0);if(a.push({x:i,y:I-r}),0===s){const t=e-o+U;n.push({points:a,offset:o,length:t}),a=[],o=-1}}e.paths=n}function P(){n.innerHTML="",X(),L.forEach((e,t)=>{const a=document.createElement("li");a.dataset.index=t,a.draggable=!0,t===x&&a.classList.add("active"),a.addEventListener("click",()=>M(t));const o=document.createElement("span");o.className="page-name",o.textContent=e.name;const s=document.createElement("button");s.className="context-menu-button",s.innerHTML="&#x22EE;",s.addEventListener("click",e=>{e.stopPropagation(),function(e,t){X();const n=e.getBoundingClientRect();V=document.createElement("ul"),V.className="context-menu",V.style.position="absolute",V.style.top=`${n.bottom}px`,V.style.left=`${n.left}px`;const a=(e,t,n=!1)=>{const a=document.createElement("li");return a.textContent=e,n?a.classList.add("disabled"):a.addEventListener("click",e=>{e.stopPropagation(),t(),X()}),a},o=0===t,s=t===L.length-1,r=L[t];B(r);const i=r.paths?r.paths.length:0,l=C>0&&C<i&&C===D;V.appendChild(a("Move Page Up",()=>J(t,t-1),o)),V.appendChild(a("Move Page Down",()=>J(t,t+1),s)),V.appendChild(document.createElement("hr")),V.appendChild(a("Merge Page Up",()=>Q(t,"up"),o)),V.appendChild(a("Merge Page Down",()=>Q(t,"down"),s)),V.appendChild(document.createElement("hr")),V.appendChild(a("Split Page",()=>function(e){const t=L[e],n=C;N={index:e,splitPoint:n},O();const a=`Split this page into two? Page "a" will have ${n} paths (blue), and page "b" will have ${t.paths.length-n} paths (red).`;setTimeout(()=>{const o=window.confirm(a);if(N=null,o){const a=t.name.replace(/.top$/i,""),o=t.paths.slice(0,n),s=t.paths.slice(n),r=e=>{if(0===e.length)return null;const n=e.map(e=>t.rawData.slice(e.offset,e.offset+e.length)),a=n.reduce((e,t)=>e+t.byteLength,0),o=new ArrayBuffer(A+a),s=new Uint8Array(o);s.set(new Uint8Array(t.rawData.slice(0,A)),0);let r=A;for(const e of n)s.set(new Uint8Array(e),r),r+=e.byteLength;return o},i=r(o),l=r(s),c=[];i&&c.push({name:`${a}-a.top`,rawData:i,paths:null}),l&&c.push({name:`${a}-b.top`,rawData:l,paths:null}),c.length>0?(L.splice(e,1,...c),M(e)):(L.splice(e,1),M(Math.max(0,e-1)))}else O()},10)}(t),!l)),V.appendChild(document.createElement("hr")),V.appendChild(a("Rename Page",()=>te(t))),V.appendChild(document.createElement("hr")),V.appendChild(a("Delete Page",()=>ee(t))),document.body.appendChild(V)}(e.currentTarget,t)}),a.appendChild(o),a.appendChild(s),n.appendChild(a)}),function(){const e=Array.from(n.querySelectorAll("li")),t=()=>{e.forEach(e=>e.classList.remove("drop-indicator-top","drop-indicator-bottom"))};e.forEach(e=>{e.addEventListener("dragstart",e=>{if(e.target.classList.contains("context-menu-button"))return void e.preventDefault();const t=e.currentTarget;Z=parseInt(t.dataset.index,10),setTimeout(()=>t.classList.add("dragging"),0),e.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",()=>{t(),e.classList.remove("dragging"),Z=null}),e.addEventListener("dragover",n=>{n.preventDefault();const a=e.getBoundingClientRect(),o=n.clientY>a.top+a.height/2;t(),o?e.classList.add("drop-indicator-bottom"):e.classList.add("drop-indicator-top")}),e.addEventListener("dragleave",()=>{}),e.addEventListener("drop",n=>{n.preventDefault(),n.stopPropagation();const a=e.getBoundingClientRect(),o=n.clientY>a.top+a.height/2;let s=parseInt(e.dataset.index,10);t(),null!==Z&&Z!==s&&(o&&s++,Z<s&&s--,J(Z,s))})}),n.addEventListener("dragend",t),n.addEventListener("dragleave",e=>{e.target===n&&t()})}()}function M(e){if(e<0||e>=L.length){if(0===L.length)return x=-1,r.clearRect(0,0,s.width,s.height),P(),void z();e=Math.max(0,Math.min(e,L.length-1))}x=e;B(L[x]),C=0,D=0,P(),O(),z()}const $=210/297;let T=1,S=0,R=0,Y=!1,W={x:0,y:0},N=null,F=null;function q(){const e=o.clientWidth,t=o.clientHeight;s.width=e,s.height=t,O()}function O(){if(x<0||x>=L.length)return void r.clearRect(0,0,s.width,s.height);const e=L[x],t=s.width,n=s.height;r.fillStyle="#e0e0e0",r.fillRect(0,0,t,n);const a=20;let o,i;(t-40)/(n-40)>$?(i=(n-40)*T,o=i*$):(o=(t-40)*T,i=o/$);S=o>t?Math.max(-(o-t)-20,Math.min(a,S)):0,R=i>n?Math.max(-(i-n)-a,Math.min(a,R)):0;let l=o<t?(t-o)/2:S,c=i<n?(n-i)/2:R;r.fillStyle="white",r.save(),r.shadowColor="rgba(0,0,0,0.2)",r.shadowBlur=15,r.shadowOffsetX=5,r.shadowOffsetY=5,r.fillRect(l,c,o,i),r.shadowColor="transparent",r.restore(),r.save(),r.beginPath(),r.rect(l,c,o,i),r.clip(),r.translate(l,c);const d=o/8800;r.scale(d,d);const u=1/d,p=F&&F.index===x,h=N&&N.index===x;(e.paths||[]).forEach((e,t)=>{if(e.points.length>0){let n="black";const a=t>=C&&t<D;if(h&&N.index===x){n=t<N.splitPoint?"blue":"red"}else p&&F.index===x?n="purple":a&&(n="blue");r.strokeStyle=n,r.lineWidth=a?3*u:u,r.beginPath(),r.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)r.lineTo(e.points[t].x,e.points[t].y);r.stroke()}}),r.restore()}window.addEventListener("resize",q);let V=null;function X(){V&&(V.remove(),V=null)}function z(){if(x<0)return;const e=L[x],t=e.paths?e.paths.length:0;if(0===t)return l.style.top="0%",void(c.style.top="0%");const n=C/t*100,a=D/t*100;l.style.top=`${n}%`,c.style.top=`${a}%`}window.addEventListener("click",e=>{!V||V.contains(e.target)||e.target.classList.contains("context-menu-button")||X()}),u.addEventListener("click",async()=>{if(!await ce())return;const e=he(ae,"users",le.uid,"documents"),t=await me(e);if(t.empty)return void b("No saved documents found.");const n=t.docs.map(e=>e.id),a=prompt("Enter the name of the document to load:\n\n"+n.join("\n"));if(a&&n.includes(a)){const e=u.querySelector("svg");try{u.disabled=!0,e.classList.add("spinner");const t=de(ae,"users",le.uid,"documents",a),n=await pe(t);if(n.exists()){const e=n.data().pages.map(e=>{const t=atob(e.data),n=new ArrayBuffer(t.length),a=new Uint8Array(n);for(let e=0;e<t.length;e++)a[e]=t.charCodeAt(e);const o=function(e){const t=(e,t)=>e&1<<t-1?e-(1<<t):e,n=(e,t,n,a)=>{const o=new ArrayBuffer(6),s=new DataView(o);return s.setUint8(0,e),s.setInt16(1,t,!0),s.setInt16(3,n,!0),s.setUint8(5,a),o},a=new DataView(e),o=[],s=32,r=new Uint8Array(e).slice(0,s).buffer;let i=s,l=0,c=0,d=0;for(;i<e.byteLength;){const e=a.getUint8(i),s=!(128&~e);let r,u,p,h,m=0;if(0===e){if(m=1,0===o.length){i+=m;continue}r=l,u=c,p=d,h=0}else if(s){m=2;const n=a.getUint8(i+1);r=l+t(e>>1&63,6),u=c+t((1&e)<<5|n>>3&31,6),p=d+t(7&n,3),h=135}else m=6,h=e,64&h&&(h|=128),h&=191,r=a.getInt16(i+1,!0),u=a.getInt16(i+3,!0),p=a.getUint8(i+5);l=r,c=u,d=p,o.push(n(h,r,u,p)),i+=m}const u=6*o.length,p=new Uint8Array(s+u);p.set(new Uint8Array(r),0);let h=s;for(const e of o)p.set(new Uint8Array(e),h),h+=6;return p.buffer}(n);return{name:e.name,rawData:o,paths:null}});if(0===L.length)L.push(...e),d.textContent=a,P(),M(0);else{if(confirm("Do you want to replace the current pages or append the new ones?"))L.length=0,L.push(...e),d.textContent=a,P(),M(0);else{const t=L.length;L.push(...e);confirm(`Document loaded. Keep current name "${d.textContent}" or use new name "${a}"?`)&&(d.textContent=a),P(),M(t)}}}else b("Document not found.")}catch(e){console.error("Error loading document:",e),b("Failed to load document. Please check the console for details.")}finally{u.disabled=!1,e.classList.remove("spinner")}}else a&&alert(`Document "${a}" not found.`)}),a.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey){const t=.05,n=e.deltaY<0?1:-1,o=Math.exp(n*t),s=a.getBoundingClientRect(),r=e.clientX-s.left,i=e.clientY-s.top,l=(r-S)/T,c=(i-R)/T;T*=o;S+=((r-S)/T-l)*T,R+=((i-R)/T-c)*T}else e.shiftKey?S-=e.deltaY:R-=e.deltaY;O()}),o.addEventListener("mousedown",e=>{Y=!0,W.x=e.clientX,W.y=e.clientY,o.style.cursor="grabbing"}),o.addEventListener("mouseup",()=>{Y=!1,o.style.cursor="grab"}),o.addEventListener("mouseleave",()=>{Y=!1,o.style.cursor="default"}),o.addEventListener("mousemove",e=>{if(Y){const t=e.clientX-W.x,n=e.clientY-W.y;S+=t,R+=n,W.x=e.clientX,W.y=e.clientY,O()}});let K=null;function H(e){K=e.target===l?l:c,document.addEventListener("mousemove",G),document.addEventListener("mouseup",j)}function j(){K=null,document.removeEventListener("mousemove",G),document.removeEventListener("mouseup",j)}function G(e){if(!K||x<0)return;const t=L[x],n=t.paths?t.paths.length:0;if(n<=1)return;const a=i.getBoundingClientRect(),o=e.clientY-a.top,s=Math.max(0,Math.min(100,o/a.height*100)),r=Math.round(n*s/100);K===l?C=Math.min(r,D):D=Math.max(r,C),C=Math.max(0,C),D=Math.min(n,D),z(),O()}function _(e){const t=e.target;let n=0;if("ArrowUp"===e.key?n=-1:"ArrowDown"===e.key?n=1:"PageUp"===e.key?n=-100:"PageDown"===e.key&&(n=100),0===n||x<0)return;e.preventDefault();const a=L[x],o=a.paths?a.paths.length:0;t===l?C=Math.max(0,Math.min(C+n,D)):D=Math.max(C,Math.min(D+n,o)),z(),O()}function J(e,t){if(t<0||t>=L.length||e===t)return;const[n]=L.splice(e,1);L.splice(t,0,n),x===e?x=t:x>e&&x<=t?x--:x<e&&x>=t&&x++,P()}function Q(e,t){const n="up"===t?e-1:e+1;if(n<0||n>=L.length)return;const a="up"===t?L[n]:L[e],o="up"===t?L[e]:L[n],s=Math.min(e,n);B(a),B(o);const r=(a.paths||[]).concat(o.paths||[]);F={index:s,data:{paths:r}},O();const i=`Are you sure you want to merge "${a.name}" and "${o.name}"?`;setTimeout(async()=>{const e=window.confirm(i);if(F=null,e){let e=a.rawData.slice(0,A);if(String.fromCharCode.apply(null,new Uint8Array(a.rawData.slice(0,A)))!==String.fromCharCode.apply(null,new Uint8Array(o.rawData.slice(0,A)))){let t=prompt(`The headers of "${a.name}" and "${o.name}" are different. Which header do you want to use? Type 'top' or 'bottom'.`,"top");for(;t&&"top"!==t.toLowerCase()&&"bottom"!==t.toLowerCase();)t=prompt("Invalid choice. Please type 'top' or 'bottom'.","top");t&&"bottom"===t.toLowerCase()&&(e=o.rawData.slice(0,A))}const t=a.rawData.slice(A),n=o.rawData.slice(A),r=new ArrayBuffer(A+t.byteLength+n.byteLength),i=new Uint8Array(r);i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),A),i.set(new Uint8Array(n),A+t.byteLength);const l={name:`${a.name.replace(/.top$/i,"")}-${o.name.replace(/.top$/i,"")}.top`,rawData:r,paths:null};L.splice(s,2,l),M(s)}else O()},10)}l.addEventListener("mousedown",H),c.addEventListener("mousedown",H),l.addEventListener("keydown",_),c.addEventListener("keydown",_);let Z=null;function ee(e){if(e<0||e>=L.length)return!1;const t=L[e].name;return!!window.confirm(`Are you sure you want to delete the page "${t}"?`)&&(L.splice(e,1),x===e?M(Math.max(0,e-1)):x>e?M(x-1):P(),!0)}function te(e){X();const t=n.querySelector(`li[data-index='${e}']`);if(!t)return;const a=t.querySelector(".page-name"),o=L[e].name,s=document.createElement("input");s.type="text",s.value=o,s.className="page-name-input",s.style.width="100%",s.addEventListener("blur",function t(){s.removeEventListener("blur",t);const n=s.value.trim();n&&n!==o&&(L[e].name=n);P()}),s.addEventListener("keydown",e=>{"Enter"===e.key?s.blur():"Escape"===e.key&&(s.value=o,s.blur())}),a.replaceWith(s),s.focus(),s.select()}window.addEventListener("keydown",function(e){if("Delete"!==e.key||x<0)return;const t=L[x];if(t)if(C<D){if(window.confirm(`Are you sure you want to delete ${D-C} selected path(s)?`)){const e=new Set(t.paths.slice(C,D)),n=t.paths.filter(t=>!e.has(t));if(0===n.length)ee(x);else{const e=n.reduce((e,t)=>e+t.length,0),a=new ArrayBuffer(A+e),o=new Uint8Array(a);o.set(new Uint8Array(t.rawData.slice(0,A)),0);let s=A;n.forEach(e=>{const n=t.rawData.slice(e.offset,e.offset+e.length);o.set(new Uint8Array(n),s),s+=n.byteLength}),t.rawData=a,t.paths=null,D=C,M(x)}}}else ee(x)}),window.addEventListener("keydown",e=>{e.ctrlKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),function(){const e=document.createElement("iframe");e.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(e);const t=e.contentWindow.document;t.write("<!DOCTYPE html><html><head><title>Print</title><style>\n            @page { size: A4 portrait; margin: 0; }\n            body { margin: 0; }\n            .page-container { width: 210mm; height: 297mm; page-break-after: always; overflow: hidden; }\n            .page-container:last-child { page-break-after: avoid; }\n            canvas { width: 100%; height: 100%; }\n        </style></head><body></body></html>");const n=t.body;L.forEach(e=>{const a=t.createElement("div");a.className="page-container";const o=t.createElement("canvas"),s=o.getContext("2d"),r=2480;o.width=r,o.height=3508,s.fillStyle="white",s.fillRect(0,0,r,3508);const i=r/8800;s.scale(i,i),s.lineWidth=5,s.strokeStyle="black",B(e),(e.paths||[]).forEach(e=>{if(e.points.length>0){s.beginPath(),s.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)s.lineTo(e.points[t].x,e.points[t].y);s.stroke()}}),a.appendChild(o),n.appendChild(a)}),t.close(),e.contentWindow.focus(),e.contentWindow.print(),setTimeout(()=>document.body.removeChild(e),500)}()):"F2"===e.key&&-1!==x&&(e.preventDefault(),te(x))});const{auth:ne,db:ae,GoogleAuthProvider:oe,signInWithPopup:se,onAuthStateChanged:re,signOut:ie}=window.firebase;let le=null;async function ce(){if(le)return!0;try{const e=new oe;return await se(ne,e),!!ne.currentUser}catch(e){return console.error("Authentication failed:",e),b("Login failed. Please check the console for details."),!1}}re(ne,e=>{le=e,e?(h.style.display="none",m.style.display="block",f.src=e.photoURL,d.textContent=e.displayName?`${e.displayName}'s Document`:"Untitled Document"):(h.style.display="block",m.style.display="none",d.textContent="Untitled Document")}),h.addEventListener("click",async()=>{try{const e=new oe;await se(ne,e)}catch(e){console.error("Authentication failed:",e),b("Login failed. Please check the console for details.")}}),w.addEventListener("click",async()=>{await ie(ne),g.style.display="none"}),y.addEventListener("click",async()=>{try{const e=new oe;e.setCustomParameters({prompt:"select_account"}),await se(ne,e)}catch(e){console.error("Authentication failed:",e),b("Login failed. Please check the console for details.")}finally{g.style.display="none"}}),f.addEventListener("click",()=>{g.style.display="block"===g.style.display?"none":"block"});const{doc:de,setDoc:ue,getDoc:pe,collection:he,getDocs:me}=window.firebase;p.addEventListener("click",async()=>{if(!await ce())return;if(0===L.length)return void b("There are no pages to save.");const e=prompt("Enter a name for your document:",d.textContent);if(!e)return;const t=p.querySelector("svg");try{p.disabled=!0,t.classList.add("spinner");const n=L.map(async e=>{const t=function(e){const t=32,n=new Uint8Array(e),a=new DataView(e,t),o=(e.byteLength-t)/6,s=[];let r=0,i=0,l=0,c=!1;const d=e=>new DataView(new ArrayBuffer(e)),u=n.slice(0,t);s.push(u.buffer);for(let e=0;e<o;e++){const t=6*e,n=a.getUint8(t),o=a.getInt16(t+1,!0),u=a.getInt16(t+3,!0),p=a.getUint8(t+5);if(0!=n){if(c){const e=o-r,t=u-i,a=p-l;if(Math.abs(e)<32&&Math.abs(t)<32&&Math.abs(a)<4){const n=d(2);let o=128;o|=(63&e)<<1,o|=t>>5&1,n.setUint8(0,o);let r=0;r|=(31&t)<<3,r|=7&a,n.setUint8(1,r),s.push(n.buffer)}else{const e=d(6);let t=127&n;128&n&&(t|=64),e.setUint8(0,t),e.setInt16(1,o,!0),e.setInt16(3,u,!0),e.setUint8(5,p),s.push(e.buffer)}}else{const e=d(6);let t=127&n;128&n&&(t|=64),e.setUint8(0,t),e.setInt16(1,o,!0),e.setInt16(3,u,!0),e.setUint8(5,p),s.push(e.buffer),c=!0}r=o,i=u,l=p}else{const e=d(1);e.setUint8(0,0),s.push(e.buffer),c=!1}}const p=s.reduce((e,t)=>e+t.byteLength,0),h=new Uint8Array(p);let m=0;for(const e of s)h.set(new Uint8Array(e),m),m+=e.byteLength;return h.buffer}(e.rawData),n=new Blob([t],{type:"application/octet-stream"}),a=await(o=n,new Promise((e,t)=>{const n=new FileReader;n.readAsDataURL(o),n.onloadend=()=>{e(n.result.split(",")[1])},n.onerror=t}));var o;return{name:e.name,data:a}}),a={pages:await Promise.all(n),createdAt:new Date},o=de(ae,"users",le.uid,"documents",e);await ue(o,a),d.textContent=e,b(`Document "${e}" saved successfully.`)}catch(e){console.error("Error saving document:",e),b("Failed to save document. Please check the console for details.")}finally{p.disabled=!1,t.classList.remove("spinner")}}),d.addEventListener("click",()=>{const e=d.textContent,t=document.createElement("input");t.type="text",t.value=e,t.className="page-name-input";t.addEventListener("blur",()=>{const n=t.value.trim();d.textContent=n&&n!==e?n:e,t.replaceWith(d)}),t.addEventListener("keydown",n=>{"Enter"===n.key&&t.blur(),"Escape"===n.key&&(t.value=e,t.blur())}),d.replaceWith(t),t.focus(),t.select()}),q(),o.style.cursor="grab"});
(()=>{var oe=(b=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(b,{get:(Z,T)=>(typeof require<"u"?require:Z)[T]}):b)(function(b){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+b+'" is not supported')});var ye=oe("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"),D=oe("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"),E=oe("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"),ke={apiKey:"",authDomain:"smash-smashin.firebaseapp.com",projectId:"smash-smashin",storageBucket:"smash-smashin.firebasestorage.app",messagingSenderId:"260759655047",appId:"1:260759655047:web:7a8931935a2557dae0de22"},ve=(0,ye.initializeApp)(ke),ae=(0,D.getAuth)(ve),se=(0,E.getFirestore)(ve);document.addEventListener("DOMContentLoaded",()=>{let b=document.getElementById("drop-zone"),Z=document.getElementById("file-input"),T=document.getElementById("page-list"),ie=document.getElementById("content-section"),C=document.getElementById("canvas-container"),k=document.getElementById("canvas"),l=k.getContext("2d"),we=document.getElementById("selection-bar"),S=document.getElementById("min-thumb"),X=document.getElementById("max-thumb"),Me=document.getElementById("title-bar"),w=document.getElementById("document-title"),I=document.getElementById("load-button"),$=document.getElementById("save-button"),Q=document.getElementById("login-button"),r=[],c=-1,p=0,v=0;b.addEventListener("click",()=>Z.click()),b.addEventListener("dragover",e=>{e.preventDefault(),b.classList.add("dragover")}),b.addEventListener("dragleave",()=>{b.classList.remove("dragover")}),b.addEventListener("drop",e=>{e.preventDefault(),b.classList.remove("dragover");let t=e.dataTransfer.files;re(t)}),Z.addEventListener("change",e=>{let t=e.target.files;re(t)});function re(e){if(e.length===0)return;let t=Array.from(e).filter(a=>a),n=r.length,o=t.map(a=>new Promise(s=>{let i=new FileReader;i.onload=d=>{let f=le(d.target.result);r.push({name:a.name,data:f}),s()},i.readAsArrayBuffer(a)}));Promise.all(o).then(()=>{R(),c===-1&&r.length>0?L(0):L(c)})}let _=32,z=6,ce=12e3;function le(e){let t=new DataView(e),n=[],o=[];for(let a=_;a+z<=t.byteLength;a+=z){let s=t.getUint8(a),i=t.getInt16(a+1,!0),d=t.getInt16(a+3,!0);o.length===0&&n.push(o),o.push({x:d,y:ce-i}),s===0&&(o=[])}return n.filter(a=>a.length>0)}function R(){T.innerHTML="",O(),r.forEach((e,t)=>{let n=document.createElement("li");n.dataset.index=t,n.draggable=!0,t===c&&n.classList.add("active"),n.addEventListener("click",()=>L(t));let o=document.createElement("span");o.className="page-name",o.textContent=e.name;let a=document.createElement("button");a.className="context-menu-button",a.innerHTML="&#x22EE;",a.addEventListener("click",s=>{s.stopPropagation(),be(s.currentTarget,t)}),n.appendChild(o),n.appendChild(a),T.appendChild(n)}),Le()}function L(e){e<0||e>=r.length?r.length===0?(c=-1,l.clearRect(0,0,k.width,k.height)):c=Math.max(0,Math.min(e,r.length-1)):c=e,p=0,v=0,R(),P(),K()}let ee=210/297,M=1,A=0,B=0,j=!1,W={x:0,y:0},U=null,F=null;function de(){let e=C.clientWidth,t=C.clientHeight;k.width=e,k.height=t,P()}window.addEventListener("resize",de);function P(){if(c<0||c>=r.length){l.clearRect(0,0,k.width,k.height);return}let e=r[c],t=k.width,n=k.height;l.fillStyle="#e0e0e0",l.fillRect(0,0,t,n);let o=20,a,s;(t-2*o)/(n-2*o)>ee?(s=(n-2*o)*M,a=s*ee):(a=(t-2*o)*M,s=a/ee),a>t?A=Math.max(-(a-t)-20,Math.min(o,A)):A=0,s>n?B=Math.max(-(s-n)-o,Math.min(o,B)):B=0;let d=a<t?(t-a)/2:A,f=s<n?(n-s)/2:B;l.fillStyle="white",l.save(),l.shadowColor="rgba(0,0,0,0.2)",l.shadowBlur=15,l.shadowOffsetX=5,l.shadowOffsetY=5,l.fillRect(d,f,a,s),l.shadowColor="transparent",l.restore(),l.save(),l.beginPath(),l.rect(d,f,a,s),l.clip(),l.translate(d,f);let g=a/8800;l.scale(g,g);let u=1/g,y=F&&F.index===c,N=U&&U.index===c;y||N?(y?F:e).data.forEach((h,V)=>{if(h.length>0){if(y)l.strokeStyle="purple";else{let x=U.splitPoint;l.strokeStyle=V<x?"blue":"red"}l.lineWidth=u,l.beginPath(),l.moveTo(h[0].x,h[0].y);for(let x=1;x<h.length;x++)l.lineTo(h[x].x,h[x].y);l.stroke()}}):e.data.forEach((h,V)=>{if(h.length>0){let x=V>=p&&V<v;l.strokeStyle=x?"blue":"black",l.lineWidth=x?u*3:u,l.beginPath(),l.moveTo(h[0].x,h[0].y);for(let J=1;J<h.length;J++)l.lineTo(h[J].x,h[J].y);l.stroke()}}),l.restore()}function Ee(e){let t=p,n=r[e];U={index:e,splitPoint:t},P();let o=`Split this page into two? Page "a" will have ${t} paths (blue), and page "b" will have ${n.data.length-t} paths (red).`;setTimeout(()=>{if(window.confirm(o)){let s=n.name,i=n.data.slice(0,t),d=n.data.slice(t),f={name:`${s}-a`,data:i},g={name:`${s}-b`,data:d};r.splice(e,1,f,g),U=null,L(e)}else U=null,P()},10)}let m=null;function be(e,t){O();let n=e.getBoundingClientRect();m=document.createElement("ul"),m.className="context-menu",m.style.position="absolute",m.style.top=`${n.bottom}px`,m.style.left=`${n.left}px`;let o=(g,u,y=!1)=>{let N=document.createElement("li");return N.textContent=g,y?N.classList.add("disabled"):N.addEventListener("click",G=>{G.stopPropagation(),u(),O()}),N},a=t===0,s=t===r.length-1,d=r[t].data.length,f=p>0&&p<d&&p===v;m.appendChild(o("Move Page Up",()=>te(t,t-1),a)),m.appendChild(o("Move Page Down",()=>te(t,t+1),s)),m.appendChild(document.createElement("hr")),m.appendChild(o("Merge Page Up",()=>fe(t,"up"),a)),m.appendChild(o("Merge Page Down",()=>fe(t,"down"),s)),m.appendChild(document.createElement("hr")),m.appendChild(o("Split Page",()=>Ee(t),!f)),m.appendChild(document.createElement("hr")),m.appendChild(o("Rename Page",()=>he(t))),m.appendChild(document.createElement("hr")),m.appendChild(o("Delete Page",()=>ne(t))),document.body.appendChild(m)}function O(){m&&(m.remove(),m=null)}window.addEventListener("click",e=>{m&&!m.contains(e.target)&&!e.target.classList.contains("context-menu-button")&&O()}),I.addEventListener("click",async()=>{if(!Y){alert("You must be logged in to load documents.");return}let e=(0,E.collection)(se,"users",Y.uid,"documents"),t=await(0,E.getDocs)(e);if(t.empty){alert("No saved documents found.");return}let n=t.docs.map(a=>a.id),o=prompt(`Enter the name of the document to load:

`+n.join(`
`));if(o&&n.includes(o))try{I.disabled=!0,I.textContent="Loading...";let a=(0,E.doc)(se,"users",Y.uid,"documents",o),s=await(0,E.getDoc)(a);if(s.exists()){let d=s.data().pages.map(g=>{let u=atob(g.data),y=new ArrayBuffer(u.length),N=new Uint8Array(y);for(let h=0;h<u.length;h++)N[h]=u.charCodeAt(h);let G=le(y);return{name:g.name,data:G}});if(r.length===0)r.push(...d),w.textContent=o,R(),L(0);else if(confirm("Do you want to replace the current pages or append the new ones?"))r.length=0,r.push(...d),w.textContent=o,R(),L(0);else{let u=r.length;r.push(...d),confirm(`Document loaded. Keep current name "${w.textContent}" or use new name "${o}"?`)&&(w.textContent=o),R(),L(u)}}else alert("Document not found.")}catch(a){console.error("Error loading document:",a),alert("Failed to load document. Please check the console for details.")}finally{I.disabled=!1,I.textContent="Load"}else o&&alert(`Document "${o}" not found.`)}),ie.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey){let n=e.deltaY<0?1:-1,o=Math.exp(n*.05),a=ie.getBoundingClientRect(),s=e.clientX-a.left,i=e.clientY-a.top,d=(s-A)/M,f=(i-B)/M;M*=o;let g=(s-A)/M,u=(i-B)/M;A+=(g-d)*M,B+=(u-f)*M}else e.shiftKey?A-=e.deltaY:B-=e.deltaY;P()}),C.addEventListener("mousedown",e=>{j=!0,W.x=e.clientX,W.y=e.clientY,C.style.cursor="grabbing"}),C.addEventListener("mouseup",()=>{j=!1,C.style.cursor="grab"}),C.addEventListener("mouseleave",()=>{j=!1,C.style.cursor="default"}),C.addEventListener("mousemove",e=>{if(j){let t=e.clientX-W.x,n=e.clientY-W.y;A+=t,B+=n,W.x=e.clientX,W.y=e.clientY,P()}});function K(){if(c<0)return;let t=r[c].data.length;if(t===0){S.style.top="0%",X.style.top="0%";return}let n=p/t*100,o=v/t*100;S.style.top=`${n}%`,X.style.top=`${o}%`}let q=null;function ue(e){q=e.target===S?S:X,document.addEventListener("mousemove",ge),document.addEventListener("mouseup",me)}function me(){q=null,document.removeEventListener("mousemove",ge),document.removeEventListener("mouseup",me)}function ge(e){if(!q||c<0)return;let n=r[c].data.length;if(n<=1)return;let o=we.getBoundingClientRect(),a=e.clientY-o.top,s=Math.max(0,Math.min(100,a/o.height*100)),i=Math.round(n*s/100);q===S?p=Math.min(i,v):v=Math.max(i,p),p=Math.max(0,p),v=Math.min(n,v),K(),P()}S.addEventListener("mousedown",ue),X.addEventListener("mousedown",ue);function pe(e){let t=e.target,n=0;if(e.key==="ArrowUp"?n=-1:e.key==="ArrowDown"?n=1:e.key==="PageUp"?n=-100:e.key==="PageDown"&&(n=100),n===0||c<0)return;e.preventDefault();let a=r[c].data.length;t===S?p=Math.max(0,Math.min(p+n,v)):v=Math.max(p,Math.min(v+n,a)),K(),P()}S.addEventListener("keydown",pe),X.addEventListener("keydown",pe);function te(e,t){if(t<0||t>=r.length||e===t)return;let[n]=r.splice(e,1);r.splice(t,0,n),c===e?c=t:c>e&&c<=t?c--:c<e&&c>=t&&c++,R()}function fe(e,t){let n=t==="up"?e-1:e+1;if(n<0||n>=r.length)return;let o=t==="up"?r[n]:r[e],a=t==="up"?r[e]:r[n],s=Math.min(e,n),i=`${o.name}-${a.name}`,d=o.data.concat(a.data);F={index:s,data:d},L(s);let f=`Are you sure you want to merge "${o.name}" and "${a.name}" into a new page named "${i}"?`;setTimeout(()=>{if(window.confirm(f)){let u={name:i,data:d};r.splice(s,2,u),F=null,L(s)}else F=null,P()},10)}let H=null;function Le(){let e=Array.from(T.querySelectorAll("li")),t=()=>{e.forEach(n=>n.classList.remove("drop-indicator-top","drop-indicator-bottom"))};e.forEach(n=>{n.addEventListener("dragstart",o=>{if(o.target.classList.contains("context-menu-button")){o.preventDefault();return}H=parseInt(o.currentTarget.dataset.index,10),setTimeout(()=>o.currentTarget.classList.add("dragging"),0),o.dataTransfer.effectAllowed="move"}),n.addEventListener("dragend",()=>{t(),n.classList.remove("dragging"),H=null}),n.addEventListener("dragover",o=>{o.preventDefault();let a=n.getBoundingClientRect(),s=o.clientY>a.top+a.height/2;t(),s?n.classList.add("drop-indicator-bottom"):n.classList.add("drop-indicator-top")}),n.addEventListener("dragleave",()=>{}),n.addEventListener("drop",o=>{o.preventDefault(),o.stopPropagation();let a=n.getBoundingClientRect(),s=o.clientY>a.top+a.height/2,i=parseInt(n.dataset.index,10);t(),!(H===null||H===i)&&(s&&i++,H<i&&i--,te(H,i))})}),T.addEventListener("dragend",t),T.addEventListener("dragleave",n=>{n.target===T&&t()})}function ne(e){if(e<0||e>=r.length)return!1;let t=r[e].name;return window.confirm(`Are you sure you want to delete the page "${t}"?`)?(r.splice(e,1),c===e?L(Math.max(0,e-1)):c>e?L(c-1):R(),!0):!1}function Pe(e){if(!(e.key!=="Delete"||c<0))if(p<v){if(window.confirm(`Are you sure you want to delete ${v-p} selected path(s)?`)){let n=r[c],o=v-p;n.data.splice(p,o),v=p,n.data.length===0&&ne(c)||(K(),P())}}else ne(c)}window.addEventListener("keydown",Pe);function Ce(){let e=document.createElement("iframe");e.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(e);let t=e.contentWindow.document;t.write(`<!DOCTYPE html><html><head><title>Print</title><style>
            @page { size: A4 portrait; margin: 0; }
            body { margin: 0; }
            .page-container { width: 210mm; height: 297mm; page-break-after: always; overflow: hidden; }
            .page-container:last-child { page-break-after: avoid; }
            canvas { width: 100%; height: 100%; }
        </style></head><body></body></html>`);let n=t.body;r.forEach(o=>{let a=t.createElement("div");a.className="page-container";let s=t.createElement("canvas"),i=s.getContext("2d"),d=2480,f=3508;s.width=d,s.height=f,i.fillStyle="white",i.fillRect(0,0,d,f);let g=d/8800;i.scale(g,g),i.lineWidth=5,i.strokeStyle="black",o.data.forEach(u=>{if(u.length>0){i.beginPath(),i.moveTo(u[0].x,u[0].y);for(let y=1;y<u.length;y++)i.lineTo(u[y].x,u[y].y);i.stroke()}}),a.appendChild(s),n.appendChild(a)}),t.close(),e.contentWindow.focus(),e.contentWindow.print(),setTimeout(()=>document.body.removeChild(e),500)}window.addEventListener("keydown",e=>{e.ctrlKey&&e.key.toLowerCase()==="p"?(e.preventDefault(),Ce()):e.key==="F2"&&c!==-1&&(e.preventDefault(),he(c))});function he(e){O();let t=T.querySelector(`li[data-index='${e}']`);if(!t)return;let n=t.querySelector(".page-name"),o=r[e].name,a=document.createElement("input");a.type="text",a.value=o,a.className="page-name-input",a.style.width="100%",a.addEventListener("blur",s),a.addEventListener("keydown",i=>{i.key==="Enter"?a.blur():i.key==="Escape"&&(a.value=o,a.blur())});function s(){a.removeEventListener("blur",s);let i=a.value.trim();i&&i!==o&&(r[e].name=i),R()}n.replaceWith(a),a.focus(),a.select()}function De(e){let t=new ArrayBuffer(_),n=[];e.forEach(i=>{i.length>0&&i.forEach((d,f)=>{let g=new ArrayBuffer(z),u=new DataView(g),y=f===i.length-1?0:1;u.setUint8(0,y),u.setInt16(1,ce-d.y,!0),u.setInt16(3,d.x,!0),n.push(g)})});let o=_+n.length*z,a=new Uint8Array(o);a.set(new Uint8Array(t),0);let s=_;return n.forEach(i=>{a.set(new Uint8Array(i),s),s+=z}),new Blob([a],{type:"application/octet-stream"})}let Te=e=>new Promise((t,n)=>{let o=new FileReader;o.readAsDataURL(e),o.onloadend=()=>{t(o.result.split(",")[1])},o.onerror=n}),Y=null;(0,D.onAuthStateChanged)(ae,e=>{Y=e,e?(Q.textContent="Logout",I.disabled=!1,$.disabled=!1,w.textContent=e.displayName?`${e.displayName}'s Document`:"Untitled Document"):(Q.textContent="Login",I.disabled=!0,$.disabled=!0,w.textContent="Untitled Document")}),Q.addEventListener("click",async()=>{if(Y)await(0,D.signOut)(ae);else try{let e=new D.GoogleAuthProvider;await(0,D.signInWithPopup)(ae,e)}catch(e){console.error("Authentication failed:",e),alert("Login failed. Please check the console for details.")}}),$.addEventListener("click",async()=>{if(!Y){alert("You must be logged in to save a document.");return}if(r.length===0){alert("There are no pages to save.");return}let e=prompt("Enter a name for your document:",w.textContent);if(e)try{$.disabled=!0,$.textContent="Saving...";let t=r.map(async s=>{let i=De(s.data),d=await Te(i);return{name:s.name,data:d}}),o={pages:await Promise.all(t),createdAt:new Date},a=(0,E.doc)(se,"users",Y.uid,"documents",e);await(0,E.setDoc)(a,o),w.textContent=e,alert(`Document "${e}" saved successfully.`)}catch(t){console.error("Error saving document:",t),alert("Failed to save document. Please check the console for details.")}finally{$.disabled=!1,$.textContent="Save"}}),w.addEventListener("click",()=>{let e=w.textContent,t=document.createElement("input");t.type="text",t.value=e,t.className="page-name-input";let n=()=>{let o=t.value.trim();w.textContent=o&&o!==e?o:e,t.replaceWith(w)};t.addEventListener("blur",n),t.addEventListener("keydown",o=>{o.key==="Enter"&&t.blur(),o.key==="Escape"&&(t.value=e,t.blur())}),w.replaceWith(t),t.focus(),t.select()}),de(),C.style.cursor="grab"});})();

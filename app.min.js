(()=>{var ee=(E=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(E,{get:(_,D)=>(typeof require<"u"?require:_)[D]}):E)(function(E){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+E+'" is not supported')});var we=ee("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"),C=ee("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"),w=ee("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"),N=ee("https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"),Te={apiKey:"",authDomain:"smash-smashin.firebaseapp.com",projectId:"smash-smashin",storageBucket:"smash-smashin.firebasestorage.app",messagingSenderId:"260759655047",appId:"1:260759655047:web:7a8931935a2557dae0de22"},re=(0,we.initializeApp)(Te),se=(0,C.getAuth)(re),ie=(0,w.getFirestore)(re),Me=(0,N.getStorage)(re);document.addEventListener("DOMContentLoaded",()=>{let E=document.getElementById("drop-zone"),_=document.getElementById("file-input"),D=document.getElementById("page-list"),ce=document.getElementById("content-section"),P=document.getElementById("canvas-container"),k=document.getElementById("canvas"),l=k.getContext("2d"),Ee=document.getElementById("selection-bar"),S=document.getElementById("min-thumb"),z=document.getElementById("max-thumb"),Be=document.getElementById("title-bar"),b=document.getElementById("document-title"),I=document.getElementById("load-button"),Y=document.getElementById("save-button"),te=document.getElementById("login-button"),r=[],c=-1,f=0,h=0;E.addEventListener("click",()=>_.click()),E.addEventListener("dragover",e=>{e.preventDefault(),E.classList.add("dragover")}),E.addEventListener("dragleave",()=>{E.classList.remove("dragover")}),E.addEventListener("drop",e=>{e.preventDefault(),E.classList.remove("dragover");let t=e.dataTransfer.files;le(t)}),_.addEventListener("change",e=>{let t=e.target.files;le(t)});function le(e){if(e.length===0)return;let t=Array.from(e).filter(a=>a),n=r.length,o=t.map(a=>new Promise(s=>{let i=new FileReader;i.onload=d=>{let m=ue(d.target.result);r.push({name:a.name,data:m}),s()},i.readAsArrayBuffer(a)}));Promise.all(o).then(()=>{U(),c===-1&&r.length>0?T(0):T(c)})}let j=32,O=6,de=12e3;function ue(e){let t=new DataView(e),n=[],o=[];for(let a=j;a+O<=t.byteLength;a+=O){let s=t.getUint8(a),i=t.getInt16(a+1,!0),d=t.getInt16(a+3,!0);o.length===0&&n.push(o),o.push({x:d,y:de-i}),s===0&&(o=[])}return n.filter(a=>a.length>0)}function U(){D.innerHTML="",K(),r.forEach((e,t)=>{let n=document.createElement("li");n.dataset.index=t,n.draggable=!0,t===c&&n.classList.add("active"),n.addEventListener("click",()=>T(t));let o=document.createElement("span");o.className="page-name",o.textContent=e.name;let a=document.createElement("button");a.className="context-menu-button",a.innerHTML="&#x22EE;",a.addEventListener("click",s=>{s.stopPropagation(),Le(s.currentTarget,t)}),n.appendChild(o),n.appendChild(a),D.appendChild(n)}),Pe()}function T(e){e<0||e>=r.length?r.length===0?(c=-1,l.clearRect(0,0,k.width,k.height)):c=Math.max(0,Math.min(e,r.length-1)):c=e,f=0,h=0,U(),L(),Z()}let ne=210/297,M=1,B=0,A=0,q=!1,W={x:0,y:0},F=null,H=null;function me(){let e=P.clientWidth,t=P.clientHeight;k.width=e,k.height=t,L()}window.addEventListener("resize",me);function L(){if(c<0||c>=r.length){l.clearRect(0,0,k.width,k.height);return}let e=r[c],t=k.width,n=k.height;l.fillStyle="#e0e0e0",l.fillRect(0,0,t,n);let o=20,a,s;(t-2*o)/(n-2*o)>ne?(s=(n-2*o)*M,a=s*ne):(a=(t-2*o)*M,s=a/ne),a>t?B=Math.max(-(a-t)-20,Math.min(o,B)):B=0,s>n?A=Math.max(-(s-n)-o,Math.min(o,A)):A=0;let d=a<t?(t-a)/2:B,m=s<n?(n-s)/2:A;l.fillStyle="white",l.save(),l.shadowColor="rgba(0,0,0,0.2)",l.shadowBlur=15,l.shadowOffsetX=5,l.shadowOffsetY=5,l.fillRect(d,m,a,s),l.shadowColor="transparent",l.restore(),l.save(),l.beginPath(),l.rect(d,m,a,s),l.clip(),l.translate(d,m);let p=a/8800;l.scale(p,p);let u=1/p,y=H&&H.index===c,$=F&&F.index===c;y||$?(y?H:e).data.forEach((v,J)=>{if(v.length>0){if(y)l.strokeStyle="purple";else{let x=F.splitPoint;l.strokeStyle=J<x?"blue":"red"}l.lineWidth=u,l.beginPath(),l.moveTo(v[0].x,v[0].y);for(let x=1;x<v.length;x++)l.lineTo(v[x].x,v[x].y);l.stroke()}}):e.data.forEach((v,J)=>{if(v.length>0){let x=J>=f&&J<h;l.strokeStyle=x?"blue":"black",l.lineWidth=x?u*3:u,l.beginPath(),l.moveTo(v[0].x,v[0].y);for(let Q=1;Q<v.length;Q++)l.lineTo(v[Q].x,v[Q].y);l.stroke()}}),l.restore()}function be(e){let t=f,n=r[e];F={index:e,splitPoint:t},L();let o=`Split this page into two? Page "a" will have ${t} paths (blue), and page "b" will have ${n.data.length-t} paths (red).`;setTimeout(()=>{if(window.confirm(o)){let s=n.name,i=n.data.slice(0,t),d=n.data.slice(t),m={name:`${s}-a`,data:i},p={name:`${s}-b`,data:d};r.splice(e,1,m,p),F=null,T(e)}else F=null,L()},10)}let g=null;function Le(e,t){K();let n=e.getBoundingClientRect();g=document.createElement("ul"),g.className="context-menu",g.style.position="absolute",g.style.top=`${n.bottom}px`,g.style.left=`${n.left}px`;let o=(p,u,y=!1)=>{let $=document.createElement("li");return $.textContent=p,y?$.classList.add("disabled"):$.addEventListener("click",V=>{V.stopPropagation(),u(),K()}),$},a=t===0,s=t===r.length-1,d=r[t].data.length,m=f>0&&f<d&&f===h;g.appendChild(o("Move Page Up",()=>oe(t,t-1),a)),g.appendChild(o("Move Page Down",()=>oe(t,t+1),s)),g.appendChild(document.createElement("hr")),g.appendChild(o("Merge Page Up",()=>ye(t,"up"),a)),g.appendChild(o("Merge Page Down",()=>ye(t,"down"),s)),g.appendChild(document.createElement("hr")),g.appendChild(o("Split Page",()=>be(t),!m)),g.appendChild(document.createElement("hr")),g.appendChild(o("Rename Page",()=>ve(t))),g.appendChild(document.createElement("hr")),g.appendChild(o("Delete Page",()=>ae(t))),document.body.appendChild(g)}function K(){g&&(g.remove(),g=null)}window.addEventListener("click",e=>{g&&!g.contains(e.target)&&!e.target.classList.contains("context-menu-button")&&K()}),I.addEventListener("click",async()=>{if(!R){alert("You must be logged in to load documents.");return}let e=(0,w.collection)(ie,"users",R.uid,"documents"),t=await(0,w.getDocs)(e);if(t.empty){alert("No saved documents found.");return}let n=t.docs.map(a=>a.id),o=prompt(`Enter the name of the document to load:

`+n.join(`
`));if(o&&n.includes(o))try{I.disabled=!0,I.textContent="Loading...";let a=(0,w.doc)(ie,"users",R.uid,"documents",o),s=await(0,w.getDoc)(a);if(s.exists()){let d=s.data().pages.map(async u=>{let $=await(await fetch(u.url)).arrayBuffer(),V=ue($);return{name:u.name,data:V}}),m=await Promise.all(d),p=r.length>0;r.push(...m),p?confirm(`Document loaded. Keep current name "${b.textContent}" or use new name "${o}"?`)&&(b.textContent=o):b.textContent=o,U(),T(r.length-m.length)}else alert("Document not found.")}catch(a){console.error("Error loading document:",a),alert("Failed to load document. Please check the console for details.")}finally{I.disabled=!1,I.textContent="Load"}else o&&alert(`Document "${o}" not found.`)}),ce.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey){let n=e.deltaY<0?1:-1,o=Math.exp(n*.05),a=ce.getBoundingClientRect(),s=e.clientX-a.left,i=e.clientY-a.top,d=(s-B)/M,m=(i-A)/M;M*=o;let p=(s-B)/M,u=(i-A)/M;B+=(p-d)*M,A+=(u-m)*M}else e.shiftKey?B-=e.deltaY:A-=e.deltaY;L()}),P.addEventListener("mousedown",e=>{q=!0,W.x=e.clientX,W.y=e.clientY,P.style.cursor="grabbing"}),P.addEventListener("mouseup",()=>{q=!1,P.style.cursor="grab"}),P.addEventListener("mouseleave",()=>{q=!1,P.style.cursor="default"}),P.addEventListener("mousemove",e=>{if(q){let t=e.clientX-W.x,n=e.clientY-W.y;B+=t,A+=n,W.x=e.clientX,W.y=e.clientY,L()}});function Z(){if(c<0)return;let t=r[c].data.length;if(t===0){S.style.top="0%",z.style.top="0%";return}let n=f/t*100,o=h/t*100;S.style.top=`${n}%`,z.style.top=`${o}%`}let G=null;function ge(e){G=e.target===S?S:z,document.addEventListener("mousemove",pe),document.addEventListener("mouseup",fe)}function fe(){G=null,document.removeEventListener("mousemove",pe),document.removeEventListener("mouseup",fe)}function pe(e){if(!G||c<0)return;let n=r[c].data.length;if(n<=1)return;let o=Ee.getBoundingClientRect(),a=e.clientY-o.top,s=Math.max(0,Math.min(100,a/o.height*100)),i=Math.round(n*s/100);G===S?f=Math.min(i,h):h=Math.max(i,f),f=Math.max(0,f),h=Math.min(n,h),Z(),L()}S.addEventListener("mousedown",ge),z.addEventListener("mousedown",ge);function he(e){let t=e.target,n=0;if(e.key==="ArrowUp"?n=-1:e.key==="ArrowDown"?n=1:e.key==="PageUp"?n=-100:e.key==="PageDown"&&(n=100),n===0||c<0)return;e.preventDefault();let a=r[c].data.length;t===S?f=Math.max(0,Math.min(f+n,h)):h=Math.max(f,Math.min(h+n,a)),Z(),L()}S.addEventListener("keydown",he),z.addEventListener("keydown",he);function oe(e,t){if(t<0||t>=r.length||e===t)return;let[n]=r.splice(e,1);r.splice(t,0,n),c===e?c=t:c>e&&c<=t?c--:c<e&&c>=t&&c++,U()}function ye(e,t){let n=t==="up"?e-1:e+1;if(n<0||n>=r.length)return;let o=t==="up"?r[n]:r[e],a=t==="up"?r[e]:r[n],s=Math.min(e,n),i=`${o.name}-${a.name}`,d=o.data.concat(a.data);H={index:s,data:d},T(s);let m=`Are you sure you want to merge "${o.name}" and "${a.name}" into a new page named "${i}"?`;setTimeout(()=>{if(window.confirm(m)){let u={name:i,data:d};r.splice(s,2,u),H=null,T(s)}else H=null,L()},10)}let X=null;function Pe(){let e=Array.from(D.querySelectorAll("li")),t=()=>{e.forEach(n=>n.classList.remove("drop-indicator-top","drop-indicator-bottom"))};e.forEach(n=>{n.addEventListener("dragstart",o=>{if(o.target.classList.contains("context-menu-button")){o.preventDefault();return}X=parseInt(o.currentTarget.dataset.index,10),setTimeout(()=>o.currentTarget.classList.add("dragging"),0),o.dataTransfer.effectAllowed="move"}),n.addEventListener("dragend",()=>{t(),n.classList.remove("dragging"),X=null}),n.addEventListener("dragover",o=>{o.preventDefault();let a=n.getBoundingClientRect(),s=o.clientY>a.top+a.height/2;t(),s?n.classList.add("drop-indicator-bottom"):n.classList.add("drop-indicator-top")}),n.addEventListener("dragleave",()=>{}),n.addEventListener("drop",o=>{o.preventDefault(),o.stopPropagation();let a=n.getBoundingClientRect(),s=o.clientY>a.top+a.height/2,i=parseInt(n.dataset.index,10);t(),!(X===null||X===i)&&(s&&i++,X<i&&i--,oe(X,i))})}),D.addEventListener("dragend",t),D.addEventListener("dragleave",n=>{n.target===D&&t()})}function ae(e){if(e<0||e>=r.length)return!1;let t=r[e].name;return window.confirm(`Are you sure you want to delete the page "${t}"?`)?(r.splice(e,1),c===e?T(Math.max(0,e-1)):c>e?T(c-1):U(),!0):!1}function Ce(e){if(!(e.key!=="Delete"||c<0))if(f<h){if(window.confirm(`Are you sure you want to delete ${h-f} selected path(s)?`)){let n=r[c],o=h-f;n.data.splice(f,o),h=f,n.data.length===0&&ae(c)||(Z(),L())}}else ae(c)}window.addEventListener("keydown",Ce);function De(){let e=document.createElement("iframe");e.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(e);let t=e.contentWindow.document;t.write(`<!DOCTYPE html><html><head><title>Print</title><style>
            @page { size: A4 portrait; margin: 0; }
            body { margin: 0; }
            .page-container { width: 210mm; height: 297mm; page-break-after: always; overflow: hidden; }
            .page-container:last-child { page-break-after: avoid; }
            canvas { width: 100%; height: 100%; }
        </style></head><body></body></html>`);let n=t.body;r.forEach(o=>{let a=t.createElement("div");a.className="page-container";let s=t.createElement("canvas"),i=s.getContext("2d"),d=2480,m=3508;s.width=d,s.height=m,i.fillStyle="white",i.fillRect(0,0,d,m);let p=d/8800;i.scale(p,p),i.lineWidth=5,i.strokeStyle="black",o.data.forEach(u=>{if(u.length>0){i.beginPath(),i.moveTo(u[0].x,u[0].y);for(let y=1;y<u.length;y++)i.lineTo(u[y].x,u[y].y);i.stroke()}}),a.appendChild(s),n.appendChild(a)}),t.close(),e.contentWindow.focus(),e.contentWindow.print(),setTimeout(()=>document.body.removeChild(e),500)}window.addEventListener("keydown",e=>{e.ctrlKey&&e.key.toLowerCase()==="p"?(e.preventDefault(),De()):e.key==="F2"&&c!==-1&&(e.preventDefault(),ve(c))});function ve(e){K();let t=D.querySelector(`li[data-index='${e}']`);if(!t)return;let n=t.querySelector(".page-name"),o=r[e].name,a=document.createElement("input");a.type="text",a.value=o,a.className="page-name-input",a.style.width="100%",a.addEventListener("blur",s),a.addEventListener("keydown",i=>{i.key==="Enter"?a.blur():i.key==="Escape"&&(a.value=o,a.blur())});function s(){a.removeEventListener("blur",s);let i=a.value.trim();i&&i!==o&&(r[e].name=i),U()}n.replaceWith(a),a.focus(),a.select()}function ke(e){let t=new ArrayBuffer(j),n=[];e.forEach(i=>{i.length>0&&i.forEach((d,m)=>{let p=new ArrayBuffer(O),u=new DataView(p),y=m===i.length-1?0:1;u.setUint8(0,y),u.setInt16(1,de-d.y,!0),u.setInt16(3,d.x,!0),n.push(p)})});let o=j+n.length*O,a=new Uint8Array(o);a.set(new Uint8Array(t),0);let s=j;return n.forEach(i=>{a.set(new Uint8Array(i),s),s+=O}),new Blob([a],{type:"application/octet-stream"})}let R=null;(0,C.onAuthStateChanged)(se,e=>{R=e,e?(te.textContent="Logout",I.disabled=!1,Y.disabled=!1,b.textContent=e.displayName?`${e.displayName}'s Document`:"Untitled Document"):(te.textContent="Login",I.disabled=!0,Y.disabled=!0,b.textContent="Untitled Document")}),te.addEventListener("click",async()=>{if(R)await(0,C.signOut)(se);else try{let e=new C.GoogleAuthProvider;await(0,C.signInWithPopup)(se,e)}catch(e){console.error("Authentication failed:",e),alert("Login failed. Please check the console for details.")}}),Y.addEventListener("click",async()=>{if(!R){alert("You must be logged in to save a document.");return}if(r.length===0){alert("There are no pages to save.");return}let e=prompt("Enter a name for your document:",b.textContent);if(e)try{Y.disabled=!0,Y.textContent="Saving...";let t=r.map(async s=>{let i=ke(s.data),d=(0,N.ref)(Me,`users/${R.uid}/documents/${e}/${s.name}.top`);await(0,N.uploadBytes)(d,i);let m=await(0,N.getDownloadURL)(d);return{name:s.name,url:m}}),o={pages:await Promise.all(t),createdAt:new Date},a=(0,w.doc)(ie,"users",R.uid,"documents",e);await(0,w.setDoc)(a,o),b.textContent=e,alert(`Document "${e}" saved successfully.`)}catch(t){console.error("Error saving document:",t),alert("Failed to save document. Please check the console for details.")}finally{Y.disabled=!1,Y.textContent="Save"}}),b.addEventListener("click",()=>{let e=b.textContent,t=document.createElement("input");t.type="text",t.value=e,t.className="page-name-input";let n=()=>{let o=t.value.trim();b.textContent=o&&o!==e?o:e,t.replaceWith(b)};t.addEventListener("blur",n),t.addEventListener("keydown",o=>{o.key==="Enter"&&t.blur(),o.key==="Escape"&&(t.value=e,t.blur())}),b.replaceWith(t),t.focus(),t.select()}),me(),P.style.cursor="grab"});})();

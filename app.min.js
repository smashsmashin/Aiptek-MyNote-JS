document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("drop-zone"),t=document.getElementById("file-input"),n=document.getElementById("page-list"),o=document.getElementById("content-section"),a=document.getElementById("canvas-container"),i=document.getElementById("canvas"),l=i.getContext("2d"),c=document.getElementById("selection-bar"),s=document.getElementById("min-thumb"),d=document.getElementById("max-thumb"),r=(document.getElementById("auth-container"),document.getElementById("user-profile")),u=document.getElementById("user-avatar"),g=document.getElementById("user-name"),p=document.getElementById("sign-out-button"),m=document.getElementById("cloud-actions"),h=document.querySelector(".g_id_signin"),f=document.getElementById("fetch-button"),y=document.getElementById("store-button"),v=[];let w=-1,E=0,b=0,k=!1;const L="181023380a20182d30313500740b18090f2135683a303d131b60010c1a6c3d172c380d362d2e08".match(/.{1,2}/g).map(e=>parseInt(e,16)).map(e=>{return(t="7c368190e98b86f6856c7765475c0b48",t.split("").map(e=>e.charCodeAt(0))).reduce((e,t)=>e^t,e);var t}).map(e=>String.fromCharCode(e)).join(""),x="414398931859-h04be241u8er4lgiun26qpavdjrnqecc.apps.googleusercontent.com",C="https://www.googleapis.com/auth/drive.file";let T,I=!1,B=!1;function P(){const e=I&&B&&k;f.disabled=!e,y.disabled=!e,e?(f.title="Fetch from Cloud",y.title="Store to Cloud"):(f.title="Initializing...",y.title="Initializing...")}async function A(){await gapi.client.init({apiKey:L,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),I=!0,P()}function M(e){if(0===e.length)return;const t=Array.from(e).filter(e=>e);v.length;const n=t.map(e=>new Promise(t=>{const n=new FileReader;n.onload=n=>{const o=function(e){const t=new DataView(e),n=[];let o=[];for(let e=S;e+$<=t.byteLength;e+=$){const a=t.getUint8(e),i=t.getInt16(e+1,!0),l=t.getInt16(e+3,!0);0===o.length&&n.push(o),o.push({x:l,y:D-i}),0===a&&(o=[])}return n.filter(e=>e.length>0)}(n.target.result);v.push({name:e.name,data:o}),t()},n.readAsArrayBuffer(e)}));Promise.all(n).then(()=>{R(),-1===w&&v.length>0?q(0):q(w)})}window.gapiLoaded=function(){gapi.load("client:picker",A)},window.gisLoaded=function(){T=google.accounts.oauth2.initTokenClient({client_id:x,scope:C,callback:""}),B=!0,P()},e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");M(t.dataTransfer.files)}),t.addEventListener("change",e=>{M(e.target.files)});const S=32,$=6,D=12e3;function R(){n.innerHTML="",G(),v.forEach((e,t)=>{const o=document.createElement("li");o.dataset.index=t,o.draggable=!0,t===w&&o.classList.add("active"),o.addEventListener("click",()=>q(t));const a=document.createElement("span");a.className="page-name",a.textContent=e.name;const i=document.createElement("button");i.className="context-menu-button",i.innerHTML="&#x22EE;",i.addEventListener("click",e=>{e.stopPropagation(),function(e,t){G();const n=e.getBoundingClientRect();_=document.createElement("ul"),_.className="context-menu",_.style.position="absolute",_.style.top=`${n.bottom}px`,_.style.left=`${n.left}px`;const o=(e,t,n=!1)=>{const o=document.createElement("li");return o.textContent=e,n?o.classList.add("disabled"):o.addEventListener("click",e=>{e.stopPropagation(),t(),G()}),o},a=0===t,i=t===v.length-1,l=v[t],c=l.data.length,s=E>0&&E<c&&E===b;_.appendChild(o("Move Page Up",()=>te(t,t-1),a)),_.appendChild(o("Move Page Down",()=>te(t,t+1),i)),_.appendChild(document.createElement("hr")),_.appendChild(o("Merge Page Up",()=>ne(t,"up"),a)),_.appendChild(o("Merge Page Down",()=>ne(t,"down"),i)),_.appendChild(document.createElement("hr")),_.appendChild(o("Split Page",()=>function(e){const t=E,n=v[e];z={index:e,splitPoint:t},X();const o=`Split this page into two? Page "a" will have ${t} paths (blue), and page "b" will have ${n.data.length-t} paths (red).`;setTimeout(()=>{if(window.confirm(o)){const o=n.name,a={name:`${o}-a`,data:n.data.slice(0,t)},i={name:`${o}-b`,data:n.data.slice(t)};v.splice(e,1,a,i),z=null,q(e)}else z=null,X()},10)}(t),!s)),_.appendChild(document.createElement("hr")),_.appendChild(o("Rename Page",()=>ie(t))),_.appendChild(document.createElement("hr")),_.appendChild(o("Delete Page",()=>ae(t))),document.body.appendChild(_)}(e.currentTarget,t)}),o.appendChild(a),o.appendChild(i),n.appendChild(o)}),function(){const e=Array.from(n.querySelectorAll("li")),t=()=>{e.forEach(e=>e.classList.remove("drop-indicator-top","drop-indicator-bottom"))};e.forEach(e=>{e.addEventListener("dragstart",e=>{e.target.classList.contains("context-menu-button")?e.preventDefault():(oe=parseInt(e.currentTarget.dataset.index,10),setTimeout(()=>e.currentTarget.classList.add("dragging"),0),e.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{t(),e.classList.remove("dragging"),oe=null}),e.addEventListener("dragover",n=>{n.preventDefault();const o=e.getBoundingClientRect(),a=n.clientY>o.top+o.height/2;t(),a?e.classList.add("drop-indicator-bottom"):e.classList.add("drop-indicator-top")}),e.addEventListener("dragleave",()=>{}),e.addEventListener("drop",n=>{n.preventDefault(),n.stopPropagation();const o=e.getBoundingClientRect(),a=n.clientY>o.top+o.height/2;let i=parseInt(e.dataset.index,10);t(),null!==oe&&oe!==i&&(a&&i++,oe<i&&i--,te(oe,i))})}),n.addEventListener("dragend",t),n.addEventListener("dragleave",e=>{e.target===n&&t()})}()}function q(e){e<0||e>=v.length?0===v.length?(w=-1,l.clearRect(0,0,i.width,i.height)):w=Math.max(0,Math.min(e,v.length-1)):w=e,E=0,b=0,R(),X(),H()}const Y=210/297;let U=1,N=0,O=0,W=!1,F={x:0,y:0},z=null,K=null;function V(){const e=a.clientWidth,t=a.clientHeight;i.width=e,i.height=t,X()}function X(){if(w<0||w>=v.length)return void l.clearRect(0,0,i.width,i.height);const e=v[w],t=i.width,n=i.height;l.fillStyle="#e0e0e0",l.fillRect(0,0,t,n);const o=20;let a,c;(t-40)/(n-40)>Y?(c=(n-40)*U,a=c*Y):(a=(t-40)*U,c=a/Y);N=a>t?Math.max(-(a-t)-20,Math.min(o,N)):0,O=c>n?Math.max(-(c-n)-o,Math.min(o,O)):0;let s=a<t?(t-a)/2:N,d=c<n?(n-c)/2:O;l.fillStyle="white",l.save(),l.shadowColor="rgba(0,0,0,0.2)",l.shadowBlur=15,l.shadowOffsetX=5,l.shadowOffsetY=5,l.fillRect(s,d,a,c),l.shadowColor="transparent",l.restore(),l.save(),l.beginPath(),l.rect(s,d,a,c),l.clip(),l.translate(s,d);const r=a/8800;l.scale(r,r);const u=1/r,g=K&&K.index===w,p=z&&z.index===w;g||p?(g?K:e).data.forEach((e,t)=>{if(e.length>0){if(g)l.strokeStyle="purple";else{const e=z.splitPoint;l.strokeStyle=t<e?"blue":"red"}l.lineWidth=u,l.beginPath(),l.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)l.lineTo(e[t].x,e[t].y);l.stroke()}}):e.data.forEach((e,t)=>{if(e.length>0){const n=t>=E&&t<b;l.strokeStyle=n?"blue":"black",l.lineWidth=n?3*u:u,l.beginPath(),l.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)l.lineTo(e[t].x,e[t].y);l.stroke()}}),l.restore()}window.addEventListener("resize",V);let _=null;function G(){_&&(_.remove(),_=null)}function H(){if(w<0)return;const e=v[w].data.length;if(0===e)return s.style.top="0%",void(d.style.top="0%");const t=E/e*100,n=b/e*100;s.style.top=`${t}%`,d.style.top=`${n}%`}window.addEventListener("click",e=>{!_||_.contains(e.target)||e.target.classList.contains("context-menu-button")||G()}),o.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey){const t=.05,n=e.deltaY<0?1:-1,a=Math.exp(n*t),i=o.getBoundingClientRect(),l=e.clientX-i.left,c=e.clientY-i.top,s=(l-N)/U,d=(c-O)/U;U*=a;N+=((l-N)/U-s)*U,O+=((c-O)/U-d)*U}else e.shiftKey?N-=e.deltaY:O-=e.deltaY;X()}),a.addEventListener("mousedown",e=>{W=!0,F.x=e.clientX,F.y=e.clientY,a.style.cursor="grabbing"}),a.addEventListener("mouseup",()=>{W=!1,a.style.cursor="grab"}),a.addEventListener("mouseleave",()=>{W=!1,a.style.cursor="default"}),a.addEventListener("mousemove",e=>{if(W){const t=e.clientX-F.x,n=e.clientY-F.y;N+=t,O+=n,F.x=e.clientX,F.y=e.clientY,X()}});let j=null;function J(e){j=e.target===s?s:d,document.addEventListener("mousemove",Z),document.addEventListener("mouseup",Q)}function Q(){j=null,document.removeEventListener("mousemove",Z),document.removeEventListener("mouseup",Q)}function Z(e){if(!j||w<0)return;const t=v[w].data.length;if(t<=1)return;const n=c.getBoundingClientRect(),o=e.clientY-n.top,a=Math.max(0,Math.min(100,o/n.height*100)),i=Math.round(t*a/100);j===s?E=Math.min(i,b):b=Math.max(i,E),E=Math.max(0,E),b=Math.min(t,b),H(),X()}function ee(e){const t=e.target;let n=0;if("ArrowUp"===e.key?n=-1:"ArrowDown"===e.key?n=1:"PageUp"===e.key?n=-100:"PageDown"===e.key&&(n=100),0===n||w<0)return;e.preventDefault();const o=v[w].data.length;t===s?E=Math.max(0,Math.min(E+n,b)):b=Math.max(E,Math.min(b+n,o)),H(),X()}function te(e,t){if(t<0||t>=v.length||e===t)return;const[n]=v.splice(e,1);v.splice(t,0,n),w===e?w=t:w>e&&w<=t?w--:w<e&&w>=t&&w++,R()}function ne(e,t){const n="up"===t?e-1:e+1;if(n<0||n>=v.length)return;const o="up"===t?v[n]:v[e],a="up"===t?v[e]:v[n],i=Math.min(e,n),l=`${o.name}-${a.name}`,c=o.data.concat(a.data);K={index:i,data:c},q(i);const s=`Are you sure you want to merge "${o.name}" and "${a.name}" into a new page named "${l}"?`;setTimeout(()=>{if(window.confirm(s)){const e={name:l,data:c};v.splice(i,2,e),K=null,q(i)}else K=null,X()},10)}s.addEventListener("mousedown",J),d.addEventListener("mousedown",J),s.addEventListener("keydown",ee),d.addEventListener("keydown",ee);let oe=null;function ae(e){if(e<0||e>=v.length)return!1;const t=v[e].name;return!!window.confirm(`Are you sure you want to delete the page "${t}"?`)&&(v.splice(e,1),w===e?q(Math.max(0,e-1)):w>e?q(w-1):R(),!0)}function ie(e){G();const t=n.querySelector(`li[data-index='${e}']`);if(!t)return;const o=t.querySelector(".page-name"),a=v[e].name,i=document.createElement("input");i.type="text",i.value=a,i.className="page-name-input",i.style.width="100%",i.addEventListener("blur",function t(){i.removeEventListener("blur",t);const n=i.value.trim();n&&n!==a&&(v[e].name=n);R()}),i.addEventListener("keydown",e=>{"Enter"===e.key?i.blur():"Escape"===e.key&&(i.value=a,i.blur())}),o.replaceWith(i),i.focus(),i.select()}function le(e){console.log(`handleAuthClick called for action: ${e}.`),console.log(`gapiInited: ${I}, gisInited: ${B}, isSignedIn: ${k}`);const t=gapi.client.getToken();null===t?(console.log("No token found. Requesting access token."),T.callback=t=>{if(console.log("Token callback received.",t),void 0!==t.error)throw console.error("Token callback error:",t.error),t;console.log("Token successfully obtained. Proceeding with action."),"fetch"===e?ce():"store"===e&&de()},google.accounts.oauth2.hasGrantedAllScopes(t,C)?(console.log("Scopes already granted, requesting token without consent prompt."),T.requestAccessToken({prompt:""})):(console.log("Scopes not granted, requesting token with consent prompt."),T.requestAccessToken({prompt:"consent"}))):(console.log("Token already exists, proceeding with action."),"fetch"===e?ce():"store"===e&&de())}function ce(){console.log("Creating Google Picker...");const e=new google.picker.View(google.picker.ViewId.DOCS);e.setMimeTypes("application/octet-stream");(new google.picker.PickerBuilder).setAppId(x.split(".")[0]).setOAuthToken(gapi.client.getToken().access_token).addView(e).setDeveloperKey(L).setCallback(se).build().setVisible(!0),console.log("Google Picker is now visible.")}async function se(e){if(e.action===google.picker.Action.PICKED){const t=e.docs[0].id,n=e.docs[0].name,o=await gapi.client.drive.files.get({fileId:t,alt:"media"}),a=new Blob([o.body],{type:"application/octet-stream"});M([new File([a],n)])}}async function de(){if(console.log("Attempting to upload current page..."),w<0||0===v.length)return console.error("Upload failed: No page selected."),void alert("No page selected to store.");const e=v[w],t=function(e){const t=new ArrayBuffer(S),n=[];e.forEach(e=>{e.length>0&&e.forEach((t,o)=>{const a=new ArrayBuffer($),i=new DataView(a),l=o===e.length-1?0:1;i.setUint8(0,l),i.setInt16(1,D-t.y,!0),i.setInt16(3,t.x,!0),n.push(a)})});const o=S+n.length*$,a=new Uint8Array(o);a.set(new Uint8Array(t),0);let i=S;return n.forEach(e=>{a.set(new Uint8Array(e),i),i+=$}),new Blob([a],{type:"application/octet-stream"})}(e.data),n=e.name;console.log(`Uploading page: "${n}"`);const o={name:n,mimeType:"application/octet-stream"},a=new FormData;a.append("metadata",new Blob([JSON.stringify(o)],{type:"application/json"})),a.append("file",t),console.log("Sending upload request to Google Drive API...");const i=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:new Headers({Authorization:"Bearer "+gapi.client.getToken().access_token}),body:a});i.ok?(console.log(`File "${n}" uploaded successfully.`),alert(`File "${n}" uploaded successfully.`)):(console.error(`Error uploading file: ${i.status} ${i.statusText}`),alert(`Error uploading file: ${i.statusText}`))}window.addEventListener("keydown",function(e){if(!("Delete"!==e.key||w<0))if(E<b){if(window.confirm(`Are you sure you want to delete ${b-E} selected path(s)?`)){const e=v[w],t=b-E;e.data.splice(E,t),b=E,0===e.data.length&&ae(w)||(H(),X())}}else ae(w)}),window.addEventListener("keydown",e=>{e.ctrlKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),function(){const e=document.createElement("iframe");e.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(e);const t=e.contentWindow.document;t.write("<!DOCTYPE html><html><head><title>Print</title><style>\n            @page { size: A4 portrait; margin: 0; }\n            body { margin: 0; }\n            .page-container { width: 210mm; height: 297mm; page-break-after: always; overflow: hidden; }\n            .page-container:last-child { page-break-after: avoid; }\n            canvas { width: 100%; height: 100%; }\n        </style></head><body></body></html>");const n=t.body;v.forEach(e=>{const o=t.createElement("div");o.className="page-container";const a=t.createElement("canvas"),i=a.getContext("2d"),l=2480;a.width=l,a.height=3508,i.fillStyle="white",i.fillRect(0,0,l,3508);const c=l/8800;i.scale(c,c),i.lineWidth=5,i.strokeStyle="black",e.data.forEach(e=>{if(e.length>0){i.beginPath(),i.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)i.lineTo(e[t].x,e[t].y);i.stroke()}}),o.appendChild(a),n.appendChild(o)}),t.close(),e.contentWindow.focus(),e.contentWindow.print(),setTimeout(()=>document.body.removeChild(e),500)}()):"F2"===e.key&&-1!==w&&(e.preventDefault(),ie(w))}),window.onSignIn=function(e){const t=e.credential,n=JSON.parse(atob(t.split(".")[1]));u.src=n.picture,g.textContent=n.name,h.style.display="none",r.style.display="block",m.style.display="block",k=!0,P()},p.addEventListener("click",function(){google.accounts.id.disableAutoSelect(),h.style.display="block",r.style.display="none",m.style.display="none",k=!1,P()}),f.addEventListener("click",()=>le("fetch")),y.addEventListener("click",()=>le("store")),V(),a.style.cursor="grab"});
document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("drop-zone"),t=document.getElementById("file-input"),n=document.getElementById("page-list"),a=document.getElementById("content-section"),o=document.getElementById("canvas-container"),r=document.getElementById("canvas"),i=r.getContext("2d"),s=document.getElementById("selection-bar"),l=document.getElementById("min-thumb"),d=document.getElementById("max-thumb"),c=(document.getElementById("title-bar"),document.getElementById("document-title")),u=document.getElementById("load-button"),h=document.getElementById("save-button"),p=document.getElementById("login-button"),m=[];let g=-1,f=0,y=0;function w(e){if(0===e.length)return;const t=Array.from(e).map(e=>new Promise((t,n)=>{const a=new FileReader;a.onload=n=>{const a=n.target.result;if(a.byteLength<v)return console.error(`File ${e.name} is smaller than the minimum header size.`),t(null);const o=a.slice(0,v);m.push({name:e.name,rawData:a,header:o,paths:null}),t(!0)},a.onerror=e=>n(e),a.readAsArrayBuffer(e)}));Promise.all(t).then(()=>{x(),-1===g&&m.length>0?C(0):C(g)})}e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");w(t.dataTransfer.files)}),t.addEventListener("change",e=>{w(e.target.files)});const v=32,E=6,b=12e3;function L(e){if(e.paths)return;const t=new DataView(e.rawData),n=[];let a=[],o=-1;for(let e=v;e+E<=t.byteLength;e+=E){-1===o&&(o=e);const r=t.getUint8(e),i=t.getInt16(e+1,!0),s=t.getInt16(e+3,!0);if(a.push({x:s,y:b-i}),0===r){const t=e-o+E;n.push({points:a,offset:o,length:t}),a=[],o=-1}}e.paths=n}function x(){n.innerHTML="",R(),m.forEach((e,t)=>{const a=document.createElement("li");a.dataset.index=t,a.draggable=!0,t===g&&a.classList.add("active"),a.addEventListener("click",()=>C(t));const o=document.createElement("span");o.className="page-name",o.textContent=e.name;const r=document.createElement("button");r.className="context-menu-button",r.innerHTML="&#x22EE;",r.addEventListener("click",e=>{e.stopPropagation(),function(e,t){R();const n=e.getBoundingClientRect();S=document.createElement("ul"),S.className="context-menu",S.style.position="absolute",S.style.top=`${n.bottom}px`,S.style.left=`${n.left}px`;const a=(e,t,n=!1)=>{const a=document.createElement("li");return a.textContent=e,n?a.classList.add("disabled"):a.addEventListener("click",e=>{e.stopPropagation(),t(),R()}),a},o=0===t,r=t===m.length-1,i=m[t];L(i);const s=i.paths?i.paths.length:0,l=f>0&&f<s&&f===y;S.appendChild(a("Move Page Up",()=>z(t,t-1),o)),S.appendChild(a("Move Page Down",()=>z(t,t+1),r)),S.appendChild(document.createElement("hr")),S.appendChild(a("Merge Page Up",()=>K(t,"up"),o)),S.appendChild(a("Merge Page Down",()=>K(t,"down"),r)),S.appendChild(document.createElement("hr")),S.appendChild(a("Split Page",()=>function(e){const t=m[e],n=f;$={index:e,splitPoint:n},T();const a=`Split this page into two? Page "a" will have ${n} paths (blue), and page "b" will have ${t.paths.length-n} paths (red).`;setTimeout(()=>{const o=window.confirm(a);if($=null,o){const a=t.name.replace(/.top$/i,""),o=t.paths.slice(0,n),r=t.paths.slice(n),i=e=>{if(0===e.length)return null;const n=e.map(e=>t.rawData.slice(e.offset,e.offset+e.length)),a=n.reduce((e,t)=>e+t.byteLength,0),o=new ArrayBuffer(v+a),r=new Uint8Array(o);r.set(new Uint8Array(t.header),0);let i=v;for(const e of n)r.set(new Uint8Array(e),i),i+=e.byteLength;return o},s=i(o),l=i(r),d=[];s&&d.push({name:`${a}-a.top`,rawData:s,header:t.header,paths:null}),l&&d.push({name:`${a}-b.top`,rawData:l,header:t.header,paths:null}),d.length>0?(m.splice(e,1,...d),C(e)):(m.splice(e,1),C(Math.max(0,e-1)))}else T()},10)}(t),!l)),S.appendChild(document.createElement("hr")),S.appendChild(a("Rename Page",()=>j(t))),S.appendChild(document.createElement("hr")),S.appendChild(a("Delete Page",()=>H(t))),document.body.appendChild(S)}(e.currentTarget,t)}),a.appendChild(o),a.appendChild(r),n.appendChild(a)}),function(){const e=Array.from(n.querySelectorAll("li")),t=()=>{e.forEach(e=>e.classList.remove("drop-indicator-top","drop-indicator-bottom"))};e.forEach(e=>{e.addEventListener("dragstart",e=>{e.target.classList.contains("context-menu-button")?e.preventDefault():(q=parseInt(e.currentTarget.dataset.index,10),setTimeout(()=>e.currentTarget.classList.add("dragging"),0),e.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{t(),e.classList.remove("dragging"),q=null}),e.addEventListener("dragover",n=>{n.preventDefault();const a=e.getBoundingClientRect(),o=n.clientY>a.top+a.height/2;t(),o?e.classList.add("drop-indicator-bottom"):e.classList.add("drop-indicator-top")}),e.addEventListener("dragleave",()=>{}),e.addEventListener("drop",n=>{n.preventDefault(),n.stopPropagation();const a=e.getBoundingClientRect(),o=n.clientY>a.top+a.height/2;let r=parseInt(e.dataset.index,10);t(),null!==q&&q!==r&&(o&&r++,q<r&&r--,z(q,r))})}),n.addEventListener("dragend",t),n.addEventListener("dragleave",e=>{e.target===n&&t()})}()}function C(e){if(e<0||e>=m.length){if(0===m.length)return g=-1,i.clearRect(0,0,r.width,r.height),x(),void Y();e=Math.max(0,Math.min(e,m.length-1))}g=e;L(m[g]),f=0,y=0,x(),T(),Y()}const D=210/297;let k=1,A=0,P=0,M=!1,B={x:0,y:0},$=null,U=null;function I(){const e=o.clientWidth,t=o.clientHeight;r.width=e,r.height=t,T()}function T(){if(g<0||g>=m.length)return void i.clearRect(0,0,r.width,r.height);const e=m[g],t=r.width,n=r.height;i.fillStyle="#e0e0e0",i.fillRect(0,0,t,n);const a=20;let o,s;(t-40)/(n-40)>D?(s=(n-40)*k,o=s*D):(o=(t-40)*k,s=o/D);A=o>t?Math.max(-(o-t)-20,Math.min(a,A)):0,P=s>n?Math.max(-(s-n)-a,Math.min(a,P)):0;let l=o<t?(t-o)/2:A,d=s<n?(n-s)/2:P;i.fillStyle="white",i.save(),i.shadowColor="rgba(0,0,0,0.2)",i.shadowBlur=15,i.shadowOffsetX=5,i.shadowOffsetY=5,i.fillRect(l,d,o,s),i.shadowColor="transparent",i.restore(),i.save(),i.beginPath(),i.rect(l,d,o,s),i.clip(),i.translate(l,d);const c=o/8800;i.scale(c,c);const u=1/c,h=U&&U.index===g,p=$&&$.index===g;(e.paths||[]).forEach((e,t)=>{if(e.points.length>0){let n="black";const a=t>=f&&t<y;if(p&&$.index===g){n=t<$.splitPoint?"blue":"red"}else h&&U.index===g?n="purple":a&&(n="blue");i.strokeStyle=n,i.lineWidth=a?3*u:u,i.beginPath(),i.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)i.lineTo(e.points[t].x,e.points[t].y);i.stroke()}}),i.restore()}window.addEventListener("resize",I);let S=null;function R(){S&&(S.remove(),S=null)}function Y(){if(g<0)return;const e=m[g],t=e.paths?e.paths.length:0;if(0===t)return l.style.top="0%",void(d.style.top="0%");const n=f/t*100,a=y/t*100;l.style.top=`${n}%`,d.style.top=`${a}%`}window.addEventListener("click",e=>{!S||S.contains(e.target)||e.target.classList.contains("context-menu-button")||R()}),u.addEventListener("click",async()=>{if(!ee)return void alert("You must be logged in to load documents.");const e=oe(V,"users",ee.uid,"documents"),t=await re(e);if(t.empty)return void alert("No saved documents found.");const n=t.docs.map(e=>e.id),a=prompt("Enter the name of the document to load:\n\n"+n.join("\n"));if(a&&n.includes(a))try{u.disabled=!0,u.textContent="Loading...";const e=te(V,"users",ee.uid,"documents",a),t=await ae(e);if(t.exists()){const e=t.data().pages.map(e=>{const t=atob(e.data),n=new ArrayBuffer(t.length),a=new Uint8Array(n);for(let e=0;e<t.length;e++)a[e]=t.charCodeAt(e);const o=n.slice(0,v);return{name:e.name,rawData:n,header:o,paths:null}});if(0===m.length)m.push(...e),c.textContent=a,x(),C(0);else{if(confirm("Do you want to replace the current pages or append the new ones?"))m.length=0,m.push(...e),c.textContent=a,x(),C(0);else{const t=m.length;m.push(...e);confirm(`Document loaded. Keep current name "${c.textContent}" or use new name "${a}"?`)&&(c.textContent=a),x(),C(t)}}}else alert("Document not found.")}catch(e){console.error("Error loading document:",e),alert("Failed to load document. Please check the console for details.")}finally{u.disabled=!1,u.textContent="Load"}else a&&alert(`Document "${a}" not found.`)}),a.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey){const t=.05,n=e.deltaY<0?1:-1,o=Math.exp(n*t),r=a.getBoundingClientRect(),i=e.clientX-r.left,s=e.clientY-r.top,l=(i-A)/k,d=(s-P)/k;k*=o;A+=((i-A)/k-l)*k,P+=((s-P)/k-d)*k}else e.shiftKey?A-=e.deltaY:P-=e.deltaY;T()}),o.addEventListener("mousedown",e=>{M=!0,B.x=e.clientX,B.y=e.clientY,o.style.cursor="grabbing"}),o.addEventListener("mouseup",()=>{M=!1,o.style.cursor="grab"}),o.addEventListener("mouseleave",()=>{M=!1,o.style.cursor="default"}),o.addEventListener("mousemove",e=>{if(M){const t=e.clientX-B.x,n=e.clientY-B.y;A+=t,P+=n,B.x=e.clientX,B.y=e.clientY,T()}});let W=null;function N(e){W=e.target===l?l:d,document.addEventListener("mousemove",O),document.addEventListener("mouseup",F)}function F(){W=null,document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",F)}function O(e){if(!W||g<0)return;const t=m[g],n=t.paths?t.paths.length:0;if(n<=1)return;const a=s.getBoundingClientRect(),o=e.clientY-a.top,r=Math.max(0,Math.min(100,o/a.height*100)),i=Math.round(n*r/100);W===l?f=Math.min(i,y):y=Math.max(i,f),f=Math.max(0,f),y=Math.min(n,y),Y(),T()}function X(e){const t=e.target;let n=0;if("ArrowUp"===e.key?n=-1:"ArrowDown"===e.key?n=1:"PageUp"===e.key?n=-100:"PageDown"===e.key&&(n=100),0===n||g<0)return;e.preventDefault();const a=m[g],o=a.paths?a.paths.length:0;t===l?f=Math.max(0,Math.min(f+n,y)):y=Math.max(f,Math.min(y+n,o)),Y(),T()}function z(e,t){if(t<0||t>=m.length||e===t)return;const[n]=m.splice(e,1);m.splice(t,0,n),g===e?g=t:g>e&&g<=t?g--:g<e&&g>=t&&g++,x()}function K(e,t){const n="up"===t?e-1:e+1;if(n<0||n>=m.length)return;const a="up"===t?m[n]:m[e],o="up"===t?m[e]:m[n],r=Math.min(e,n);L(a),L(o);const i=(a.paths||[]).concat(o.paths||[]);U={index:r,data:{paths:i}},T();const s=`Are you sure you want to merge "${a.name}" and "${o.name}"?`;setTimeout(async()=>{const e=window.confirm(s);if(U=null,e){let e=a.header;if(String.fromCharCode.apply(null,new Uint8Array(a.header))!==String.fromCharCode.apply(null,new Uint8Array(o.header))){let t=prompt(`The headers of "${a.name}" and "${o.name}" are different. Which header do you want to use? Type 'top' or 'bottom'.`,"top");for(;t&&"top"!==t.toLowerCase()&&"bottom"!==t.toLowerCase();)t=prompt("Invalid choice. Please type 'top' or 'bottom'.","top");t&&"bottom"===t.toLowerCase()&&(e=o.header)}const t=a.rawData.slice(v),n=o.rawData.slice(v),i=new ArrayBuffer(v+t.byteLength+n.byteLength),s=new Uint8Array(i);s.set(new Uint8Array(e),0),s.set(new Uint8Array(t),v),s.set(new Uint8Array(n),v+t.byteLength);const l={name:`${a.name.replace(/.top$/i,"")}-${o.name.replace(/.top$/i,"")}.top`,rawData:i,header:e,paths:null};m.splice(r,2,l),C(r)}else T()},10)}l.addEventListener("mousedown",N),d.addEventListener("mousedown",N),l.addEventListener("keydown",X),d.addEventListener("keydown",X);let q=null;function H(e){if(e<0||e>=m.length)return!1;const t=m[e].name;return!!window.confirm(`Are you sure you want to delete the page "${t}"?`)&&(m.splice(e,1),g===e?C(Math.max(0,e-1)):g>e?C(g-1):x(),!0)}function j(e){R();const t=n.querySelector(`li[data-index='${e}']`);if(!t)return;const a=t.querySelector(".page-name"),o=m[e].name,r=document.createElement("input");r.type="text",r.value=o,r.className="page-name-input",r.style.width="100%",r.addEventListener("blur",function t(){r.removeEventListener("blur",t);const n=r.value.trim();n&&n!==o&&(m[e].name=n);x()}),r.addEventListener("keydown",e=>{"Enter"===e.key?r.blur():"Escape"===e.key&&(r.value=o,r.blur())}),a.replaceWith(r),r.focus(),r.select()}window.addEventListener("keydown",function(e){if("Delete"!==e.key||g<0)return;const t=m[g];if(t)if(f<y){if(window.confirm(`Are you sure you want to delete ${y-f} selected path(s)?`)){const e=new Set(t.paths.slice(f,y)),n=t.paths.filter(t=>!e.has(t));if(0===n.length)H(g);else{const e=n.reduce((e,t)=>e+t.length,0),a=new ArrayBuffer(v+e),o=new Uint8Array(a);o.set(new Uint8Array(t.header),0);let r=v;n.forEach(e=>{const n=t.rawData.slice(e.offset,e.offset+e.length);o.set(new Uint8Array(n),r),r+=n.byteLength}),t.rawData=a,t.paths=null,y=f,C(g)}}}else H(g)}),window.addEventListener("keydown",e=>{e.ctrlKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),function(){const e=document.createElement("iframe");e.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(e);const t=e.contentWindow.document;t.write("<!DOCTYPE html><html><head><title>Print</title><style>\n            @page { size: A4 portrait; margin: 0; }\n            body { margin: 0; }\n            .page-container { width: 210mm; height: 297mm; page-break-after: always; overflow: hidden; }\n            .page-container:last-child { page-break-after: avoid; }\n            canvas { width: 100%; height: 100%; }\n        </style></head><body></body></html>");const n=t.body;m.forEach(e=>{const a=t.createElement("div");a.className="page-container";const o=t.createElement("canvas"),r=o.getContext("2d"),i=2480;o.width=i,o.height=3508,r.fillStyle="white",r.fillRect(0,0,i,3508);const s=i/8800;r.scale(s,s),r.lineWidth=5,r.strokeStyle="black",L(e),(e.paths||[]).forEach(e=>{if(e.points.length>0){r.beginPath(),r.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)r.lineTo(e.points[t].x,e.points[t].y);r.stroke()}}),a.appendChild(o),n.appendChild(a)}),t.close(),e.contentWindow.focus(),e.contentWindow.print(),setTimeout(()=>document.body.removeChild(e),500)}()):"F2"===e.key&&-1!==g&&(e.preventDefault(),j(g))});const{auth:G,db:V,GoogleAuthProvider:J,signInWithPopup:Q,onAuthStateChanged:Z,signOut:_}=window.firebase;let ee=null;Z(G,e=>{ee=e,e?(p.textContent="Logout",u.disabled=!1,h.disabled=!1,c.textContent=e.displayName?`${e.displayName}'s Document`:"Untitled Document"):(p.textContent="Login",u.disabled=!0,h.disabled=!0,c.textContent="Untitled Document")}),p.addEventListener("click",async()=>{if(ee)await _(G);else try{const e=new J;await Q(G,e)}catch(e){console.error("Authentication failed:",e),alert("Login failed. Please check the console for details.")}});const{doc:te,setDoc:ne,getDoc:ae,collection:oe,getDocs:re}=window.firebase;h.addEventListener("click",async()=>{if(!ee)return void alert("You must be logged in to save a document.");if(0===m.length)return void alert("There are no pages to save.");const e=prompt("Enter a name for your document:",c.textContent);if(e)try{h.disabled=!0,h.textContent="Saving...";const t=m.map(async e=>{const t=new Blob([e.rawData],{type:"application/octet-stream"}),n=await(a=t,new Promise((e,t)=>{const n=new FileReader;n.readAsDataURL(a),n.onloadend=()=>{e(n.result.split(",")[1])},n.onerror=t}));var a;return{name:e.name,data:n}}),n={pages:await Promise.all(t),createdAt:new Date},a=te(V,"users",ee.uid,"documents",e);await ne(a,n),c.textContent=e,alert(`Document "${e}" saved successfully.`)}catch(e){console.error("Error saving document:",e),alert("Failed to save document. Please check the console for details.")}finally{h.disabled=!1,h.textContent="Save"}}),c.addEventListener("click",()=>{const e=c.textContent,t=document.createElement("input");t.type="text",t.value=e,t.className="page-name-input";t.addEventListener("blur",()=>{const n=t.value.trim();c.textContent=n&&n!==e?n:e,t.replaceWith(c)}),t.addEventListener("keydown",n=>{"Enter"===n.key&&t.blur(),"Escape"===n.key&&(t.value=e,t.blur())}),c.replaceWith(t),t.focus(),t.select()}),I(),o.style.cursor="grab"});
document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("drop-zone"),t=document.getElementById("file-input"),n=document.getElementById("page-list"),a=document.getElementById("content-section"),o=document.getElementById("canvas-container"),i=document.getElementById("canvas"),d=i.getContext("2d"),l=document.getElementById("selection-bar"),r=document.getElementById("min-thumb"),s=document.getElementById("max-thumb"),c=(document.getElementById("title-bar"),document.getElementById("document-title")),u=document.getElementById("load-button"),m=document.getElementById("save-button"),h=document.getElementById("login-button"),g=[];let p=-1,f=0,v=0;function y(e){if(0===e.length)return;const t=Array.from(e).filter(e=>e);g.length;const n=t.map(e=>new Promise(t=>{const n=new FileReader;n.onload=n=>{const a=L(n.target.result);g.push({name:e.name,data:a}),t()},n.readAsArrayBuffer(e)}));Promise.all(n).then(()=>{x(),-1===p&&g.length>0?C(0):C(p)})}e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");y(t.dataTransfer.files)}),t.addEventListener("change",e=>{y(e.target.files)});const w=32,E=6,b=12e3;function L(e){const t=new DataView(e),n=[];let a=[];for(let e=w;e+E<=t.byteLength;e+=E){const o=t.getUint8(e),i=t.getInt16(e+1,!0),d=t.getInt16(e+3,!0);0===a.length&&n.push(a),a.push({x:d,y:b-i}),0===o&&(a=[])}return n.filter(e=>e.length>0)}function x(){n.innerHTML="",Y(),g.forEach((e,t)=>{const a=document.createElement("li");a.dataset.index=t,a.draggable=!0,t===p&&a.classList.add("active"),a.addEventListener("click",()=>C(t));const o=document.createElement("span");o.className="page-name",o.textContent=e.name;const i=document.createElement("button");i.className="context-menu-button",i.innerHTML="&#x22EE;",i.addEventListener("click",e=>{e.stopPropagation(),function(e,t){Y();const n=e.getBoundingClientRect();R=document.createElement("ul"),R.className="context-menu",R.style.position="absolute",R.style.top=`${n.bottom}px`,R.style.left=`${n.left}px`;const a=(e,t,n=!1)=>{const a=document.createElement("li");return a.textContent=e,n?a.classList.add("disabled"):a.addEventListener("click",e=>{e.stopPropagation(),t(),Y()}),a},o=0===t,i=t===g.length-1,d=g[t],l=d.data.length,r=f>0&&f<l&&f===v;R.appendChild(a("Move Page Up",()=>K(t,t-1),o)),R.appendChild(a("Move Page Down",()=>K(t,t+1),i)),R.appendChild(document.createElement("hr")),R.appendChild(a("Merge Page Up",()=>q(t,"up"),o)),R.appendChild(a("Merge Page Down",()=>q(t,"down"),i)),R.appendChild(document.createElement("hr")),R.appendChild(a("Split Page",()=>function(e){const t=f,n=g[e];I={index:e,splitPoint:t},S();const a=`Split this page into two? Page "a" will have ${t} paths (blue), and page "b" will have ${n.data.length-t} paths (red).`;setTimeout(()=>{if(window.confirm(a)){const a=n.name,o={name:`${a}-a`,data:n.data.slice(0,t)},i={name:`${a}-b`,data:n.data.slice(t)};g.splice(e,1,o,i),I=null,C(e)}else I=null,S()},10)}(t),!r)),R.appendChild(document.createElement("hr")),R.appendChild(a("Rename Page",()=>V(t))),R.appendChild(document.createElement("hr")),R.appendChild(a("Delete Page",()=>H(t))),document.body.appendChild(R)}(e.currentTarget,t)}),a.appendChild(o),a.appendChild(i),n.appendChild(a)}),function(){const e=Array.from(n.querySelectorAll("li")),t=()=>{e.forEach(e=>e.classList.remove("drop-indicator-top","drop-indicator-bottom"))};e.forEach(e=>{e.addEventListener("dragstart",e=>{e.target.classList.contains("context-menu-button")?e.preventDefault():(z=parseInt(e.currentTarget.dataset.index,10),setTimeout(()=>e.currentTarget.classList.add("dragging"),0),e.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{t(),e.classList.remove("dragging"),z=null}),e.addEventListener("dragover",n=>{n.preventDefault();const a=e.getBoundingClientRect(),o=n.clientY>a.top+a.height/2;t(),o?e.classList.add("drop-indicator-bottom"):e.classList.add("drop-indicator-top")}),e.addEventListener("dragleave",()=>{}),e.addEventListener("drop",n=>{n.preventDefault(),n.stopPropagation();const a=e.getBoundingClientRect(),o=n.clientY>a.top+a.height/2;let i=parseInt(e.dataset.index,10);t(),null!==z&&z!==i&&(o&&i++,z<i&&i--,K(z,i))})}),n.addEventListener("dragend",t),n.addEventListener("dragleave",e=>{e.target===n&&t()})}()}function C(e){e<0||e>=g.length?0===g.length?(p=-1,d.clearRect(0,0,i.width,i.height)):p=Math.max(0,Math.min(e,g.length-1)):p=e,f=0,v=0,x(),S(),U()}const k=210/297;let D=1,P=0,M=0,A=!1,B={x:0,y:0},I=null,$=null;function T(){const e=o.clientWidth,t=o.clientHeight;i.width=e,i.height=t,S()}function S(){if(p<0||p>=g.length)return void d.clearRect(0,0,i.width,i.height);const e=g[p],t=i.width,n=i.height;d.fillStyle="#e0e0e0",d.fillRect(0,0,t,n);const a=20;let o,l;(t-40)/(n-40)>k?(l=(n-40)*D,o=l*k):(o=(t-40)*D,l=o/k);P=o>t?Math.max(-(o-t)-20,Math.min(a,P)):0,M=l>n?Math.max(-(l-n)-a,Math.min(a,M)):0;let r=o<t?(t-o)/2:P,s=l<n?(n-l)/2:M;d.fillStyle="white",d.save(),d.shadowColor="rgba(0,0,0,0.2)",d.shadowBlur=15,d.shadowOffsetX=5,d.shadowOffsetY=5,d.fillRect(r,s,o,l),d.shadowColor="transparent",d.restore(),d.save(),d.beginPath(),d.rect(r,s,o,l),d.clip(),d.translate(r,s);const c=o/8800;d.scale(c,c);const u=1/c,m=$&&$.index===p,h=I&&I.index===p;m||h?(m?$:e).data.forEach((e,t)=>{if(e.length>0){if(m)d.strokeStyle="purple";else{const e=I.splitPoint;d.strokeStyle=t<e?"blue":"red"}d.lineWidth=u,d.beginPath(),d.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)d.lineTo(e[t].x,e[t].y);d.stroke()}}):e.data.forEach((e,t)=>{if(e.length>0){const n=t>=f&&t<v;d.strokeStyle=n?"blue":"black",d.lineWidth=n?3*u:u,d.beginPath(),d.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)d.lineTo(e[t].x,e[t].y);d.stroke()}}),d.restore()}window.addEventListener("resize",T);let R=null;function Y(){R&&(R.remove(),R=null)}function U(){if(p<0)return;const e=g[p].data.length;if(0===e)return r.style.top="0%",void(s.style.top="0%");const t=f/e*100,n=v/e*100;r.style.top=`${t}%`,s.style.top=`${n}%`}window.addEventListener("click",e=>{!R||R.contains(e.target)||e.target.classList.contains("context-menu-button")||Y()}),u.addEventListener("click",async()=>{if(!ee)return void alert("You must be logged in to load documents.");const e=oe(G,"users",ee.uid,"documents"),t=await ie(e);if(t.empty)return void alert("No saved documents found.");const n=t.docs.map(e=>e.id),a=prompt("Enter the name of the document to load:\n\n"+n.join("\n"));if(a&&n.includes(a))try{u.disabled=!0,u.textContent="Loading...";const e=te(G,"users",ee.uid,"documents",a),t=await ae(e);if(t.exists()){const e=t.data().pages.map(e=>{const t=atob(e.data),n=new ArrayBuffer(t.length),a=new Uint8Array(n);for(let e=0;e<t.length;e++)a[e]=t.charCodeAt(e);const o=L(n);return{name:e.name,data:o}}),n=0===g.length;if(g.push(...e),n)c.textContent=a;else{confirm(`Document loaded. Keep current name "${c.textContent}" or use new name "${a}"?`)&&(c.textContent=a)}x(),C(g.length-e.length)}else alert("Document not found.")}catch(e){console.error("Error loading document:",e),alert("Failed to load document. Please check the console for details.")}finally{u.disabled=!1,u.textContent="Load"}else a&&alert(`Document "${a}" not found.`)}),a.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey){const t=.05,n=e.deltaY<0?1:-1,o=Math.exp(n*t),i=a.getBoundingClientRect(),d=e.clientX-i.left,l=e.clientY-i.top,r=(d-P)/D,s=(l-M)/D;D*=o;P+=((d-P)/D-r)*D,M+=((l-M)/D-s)*D}else e.shiftKey?P-=e.deltaY:M-=e.deltaY;S()}),o.addEventListener("mousedown",e=>{A=!0,B.x=e.clientX,B.y=e.clientY,o.style.cursor="grabbing"}),o.addEventListener("mouseup",()=>{A=!1,o.style.cursor="grab"}),o.addEventListener("mouseleave",()=>{A=!1,o.style.cursor="default"}),o.addEventListener("mousemove",e=>{if(A){const t=e.clientX-B.x,n=e.clientY-B.y;P+=t,M+=n,B.x=e.clientX,B.y=e.clientY,S()}});let W=null;function N(e){W=e.target===r?r:s,document.addEventListener("mousemove",O),document.addEventListener("mouseup",F)}function F(){W=null,document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",F)}function O(e){if(!W||p<0)return;const t=g[p].data.length;if(t<=1)return;const n=l.getBoundingClientRect(),a=e.clientY-n.top,o=Math.max(0,Math.min(100,a/n.height*100)),i=Math.round(t*o/100);W===r?f=Math.min(i,v):v=Math.max(i,f),f=Math.max(0,f),v=Math.min(t,v),U(),S()}function X(e){const t=e.target;let n=0;if("ArrowUp"===e.key?n=-1:"ArrowDown"===e.key?n=1:"PageUp"===e.key?n=-100:"PageDown"===e.key&&(n=100),0===n||p<0)return;e.preventDefault();const a=g[p].data.length;t===r?f=Math.max(0,Math.min(f+n,v)):v=Math.max(f,Math.min(v+n,a)),U(),S()}function K(e,t){if(t<0||t>=g.length||e===t)return;const[n]=g.splice(e,1);g.splice(t,0,n),p===e?p=t:p>e&&p<=t?p--:p<e&&p>=t&&p++,x()}function q(e,t){const n="up"===t?e-1:e+1;if(n<0||n>=g.length)return;const a="up"===t?g[n]:g[e],o="up"===t?g[e]:g[n],i=Math.min(e,n),d=`${a.name}-${o.name}`,l=a.data.concat(o.data);$={index:i,data:l},C(i);const r=`Are you sure you want to merge "${a.name}" and "${o.name}" into a new page named "${d}"?`;setTimeout(()=>{if(window.confirm(r)){const e={name:d,data:l};g.splice(i,2,e),$=null,C(i)}else $=null,S()},10)}r.addEventListener("mousedown",N),s.addEventListener("mousedown",N),r.addEventListener("keydown",X),s.addEventListener("keydown",X);let z=null;function H(e){if(e<0||e>=g.length)return!1;const t=g[e].name;return!!window.confirm(`Are you sure you want to delete the page "${t}"?`)&&(g.splice(e,1),p===e?C(Math.max(0,e-1)):p>e?C(p-1):x(),!0)}function V(e){Y();const t=n.querySelector(`li[data-index='${e}']`);if(!t)return;const a=t.querySelector(".page-name"),o=g[e].name,i=document.createElement("input");i.type="text",i.value=o,i.className="page-name-input",i.style.width="100%",i.addEventListener("blur",function t(){i.removeEventListener("blur",t);const n=i.value.trim();n&&n!==o&&(g[e].name=n);x()}),i.addEventListener("keydown",e=>{"Enter"===e.key?i.blur():"Escape"===e.key&&(i.value=o,i.blur())}),a.replaceWith(i),i.focus(),i.select()}window.addEventListener("keydown",function(e){if(!("Delete"!==e.key||p<0))if(f<v){if(window.confirm(`Are you sure you want to delete ${v-f} selected path(s)?`)){const e=g[p],t=v-f;e.data.splice(f,t),v=f,0===e.data.length&&H(p)||(U(),S())}}else H(p)}),window.addEventListener("keydown",e=>{e.ctrlKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),function(){const e=document.createElement("iframe");e.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(e);const t=e.contentWindow.document;t.write("<!DOCTYPE html><html><head><title>Print</title><style>\n            @page { size: A4 portrait; margin: 0; }\n            body { margin: 0; }\n            .page-container { width: 210mm; height: 297mm; page-break-after: always; overflow: hidden; }\n            .page-container:last-child { page-break-after: avoid; }\n            canvas { width: 100%; height: 100%; }\n        </style></head><body></body></html>");const n=t.body;g.forEach(e=>{const a=t.createElement("div");a.className="page-container";const o=t.createElement("canvas"),i=o.getContext("2d"),d=2480;o.width=d,o.height=3508,i.fillStyle="white",i.fillRect(0,0,d,3508);const l=d/8800;i.scale(l,l),i.lineWidth=5,i.strokeStyle="black",e.data.forEach(e=>{if(e.length>0){i.beginPath(),i.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)i.lineTo(e[t].x,e[t].y);i.stroke()}}),a.appendChild(o),n.appendChild(a)}),t.close(),e.contentWindow.focus(),e.contentWindow.print(),setTimeout(()=>document.body.removeChild(e),500)}()):"F2"===e.key&&-1!==p&&(e.preventDefault(),V(p))});const{auth:j,db:G,GoogleAuthProvider:J,signInWithPopup:Q,onAuthStateChanged:Z,signOut:_}=window.firebase;let ee=null;Z(j,e=>{ee=e,e?(h.textContent="Logout",u.disabled=!1,m.disabled=!1,c.textContent=e.displayName?`${e.displayName}'s Document`:"Untitled Document"):(h.textContent="Login",u.disabled=!0,m.disabled=!0,c.textContent="Untitled Document")}),h.addEventListener("click",async()=>{if(ee)await _(j);else try{const e=new J;await Q(j,e)}catch(e){console.error("Authentication failed:",e),alert("Login failed. Please check the console for details.")}});const{doc:te,setDoc:ne,getDoc:ae,collection:oe,getDocs:ie}=window.firebase;m.addEventListener("click",async()=>{if(!ee)return void alert("You must be logged in to save a document.");if(0===g.length)return void alert("There are no pages to save.");const e=prompt("Enter a name for your document:",c.textContent);if(e)try{m.disabled=!0,m.textContent="Saving...";const t=g.map(async e=>{const t=function(e){const t=new ArrayBuffer(w),n=[];e.forEach(e=>{e.length>0&&e.forEach((t,a)=>{const o=new ArrayBuffer(E),i=new DataView(o),d=a===e.length-1?0:1;i.setUint8(0,d),i.setInt16(1,b-t.y,!0),i.setInt16(3,t.x,!0),n.push(o)})});const a=w+n.length*E,o=new Uint8Array(a);o.set(new Uint8Array(t),0);let i=w;return n.forEach(e=>{o.set(new Uint8Array(e),i),i+=E}),new Blob([o],{type:"application/octet-stream"})}(e.data),n=await(a=t,new Promise((e,t)=>{const n=new FileReader;n.readAsDataURL(a),n.onloadend=()=>{e(n.result.split(",")[1])},n.onerror=t}));var a;return{name:e.name,data:n}}),n={pages:await Promise.all(t),createdAt:new Date},a=te(G,"users",ee.uid,"documents",e);await ne(a,n),c.textContent=e,alert(`Document "${e}" saved successfully.`)}catch(e){console.error("Error saving document:",e),alert("Failed to save document. Please check the console for details.")}finally{m.disabled=!1,m.textContent="Save"}}),c.addEventListener("click",()=>{const e=c.textContent,t=document.createElement("input");t.type="text",t.value=e,t.className="page-name-input";t.addEventListener("blur",()=>{const n=t.value.trim();c.textContent=n&&n!==e?n:e,t.replaceWith(c)}),t.addEventListener("keydown",n=>{"Enter"===n.key&&t.blur(),"Escape"===n.key&&(t.value=e,t.blur())}),c.replaceWith(t),t.focus(),t.select()}),T(),o.style.cursor="grab"});
const TOP_HEADER_SIZE=32,TOP_PACKET_SIZE=6,TOP_HEIGHT=12e3;function compressPointsWithHeader(e){const t=function(e){const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer}(e),n=new Uint8Array(t),r=new DataView(t,32),o=(t.byteLength-32)/6,a=[];let s=0,i=0,l=0,c=!1;const d=e=>new DataView(new ArrayBuffer(e)),u=n.slice(0,32);a.push(u.buffer);for(let e=0;e<o;e++){const t=6*e,n=r.getUint8(t),o=r.getInt16(t+1,!0),u=r.getInt16(t+3,!0),f=r.getUint8(t+5);if(0!=n){if(c){const e=o-s,t=u-i,r=f-l;if(Math.abs(e)<32&&Math.abs(t)<32&&Math.abs(r)<4){const n=d(2);let o=128;o|=(63&e)<<1,o|=t>>5&1,n.setUint8(0,o);let s=0;s|=(31&t)<<3,s|=7&r,n.setUint8(1,s),a.push(n.buffer)}else{const e=d(6);let t=127&n;128&n&&(t|=64),e.setUint8(0,t),e.setInt16(1,o,!0),e.setInt16(3,u,!0),e.setUint8(5,f),a.push(e.buffer)}}else{const e=d(6);let t=127&n;128&n&&(t|=64),e.setUint8(0,t),e.setInt16(1,o,!0),e.setInt16(3,u,!0),e.setUint8(5,f),a.push(e.buffer),c=!0}s=o,i=u,l=f}else{const e=d(1);e.setUint8(0,0),a.push(e.buffer),c=!1}}const f=a.reduce((e,t)=>e+t.byteLength,0),g=new Uint8Array(f);let h=0;for(const e of a)g.set(new Uint8Array(e),h),h+=e.byteLength;return function(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.byteLength;e++)t+=String.fromCharCode(n[e]);return btoa(t)}(g.buffer)}function decompressPointsWithHeader(e){const t=(e,t)=>{console.log(`getSignedValue: value=${e}, bitCount=${t}`);if(e&1<<t-1){const n=e-(1<<t);return console.log(`getSignedValue: result=${n}`),n}return console.log(`getSignedValue: result=${e}`),e},n=(e,t,n,r)=>{const o=new ArrayBuffer(6),a=new DataView(o);return a.setUint8(0,e),a.setInt16(1,t,!0),a.setInt16(3,n,!0),a.setUint8(5,r),o},r=function(e){const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer}(e),o=new DataView(r),a=[],s=new Uint8Array(r).slice(0,32).buffer;let i=32,l=0,c=0,d=0,u=0;for(;i<r.byteLength;){const e=o.getUint8(i),r=!(128&~e);let s,f,g,h,m=0;if(0===e){if(m=1,0===a.length){i+=m;continue}s=l,f=c,g=d,h=0}else if(r){m=2;const n=o.getUint8(i+1);s=l+t(e>>1&63,6),f=c+t((1&e)<<5|n>>3&31,6),g=d+t(7&n,3),h=135}else m=6,h=e,64&h&&(h|=128,h&=183),s=o.getInt16(i+1,!0),f=o.getInt16(i+3,!0),g=o.getUint8(i+5);l=s,c=f,d=g,u=h,a.push(n(h,s,f,g)),i+=m}const f=6*a.length,g=new Uint8Array(32+f);g.set(new Uint8Array(s),0);let h=32;for(const e of a)g.set(new Uint8Array(e),h),h+=6;return function(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.byteLength;e++)t+=String.fromCharCode(n[e]);return btoa(t)}(g.buffer)}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("drop-zone"),t=document.getElementById("file-input"),n=document.getElementById("page-list"),r=(document.getElementById("content-section"),document.getElementById("canvas-container")),o=document.getElementById("canvas"),a=o.getContext("2d"),s=(document.getElementById("selection-bar"),document.getElementById("min-thumb"),document.getElementById("max-thumb"),document.getElementById("title-bar"),document.getElementById("document-title"),document.getElementById("load-button"),document.getElementById("save-button"),document.getElementById("login-button"),[]);let i=-1,l=0,c=0;function d(e){if(0===e.length)return;const t=Array.from(e).filter(e=>e).map(e=>new Promise(t=>{const n=new FileReader;n.onload=n=>{s.push({name:e.name,fileBuffer:n.target.result,parsedData:null}),t()},n.readAsArrayBuffer(e)}));Promise.all(t).then(()=>{f(),-1===i&&s.length>0?g(0):g(i)})}function u(e){if(e<0||e>=s.length)return null;const t=s[e];if(t.parsedData)return t.parsedData;const n=function(e){const t=e.slice(0,32),n=new DataView(e),r=[];let o=[];for(let e=32;e+6<=n.byteLength;e+=6){const t=n.getUint8(e),a=n.getInt16(e+1,!0),s=n.getInt16(e+3,!0),i=n.getUint8(e+5);0!==t&&0===o.length&&r.push(o),o.push({x:s,y:12e3-a,p:i,penStatus:t}),0===t&&(o=[])}return{header:t,data:r.filter(e=>e.length>1)}}(t.fileBuffer);return t.parsedData=n,n}function f(){n.innerHTML="",function(){const e=document.querySelector(".context-menu");e&&e.remove()}(),s.forEach((e,t)=>{const r=document.createElement("li");r.dataset.index=t,r.draggable=!0,t===i&&r.classList.add("active"),r.addEventListener("click",()=>g(t));const o=document.createElement("span");o.className="page-name",o.textContent=e.name;const a=document.createElement("button");a.className="context-menu-button",a.innerHTML="&#x22EE;",a.addEventListener("click",e=>{e.stopPropagation(),function(e,t){console.log("Context menu for page "+t+" requested.")}(e.currentTarget,t)}),r.appendChild(o),r.appendChild(a),n.appendChild(r)}),addDragDropListeners()}function g(e){e<0||e>=s.length?0===s.length?(i=-1,a.clearRect(0,0,o.width,o.height)):i=Math.max(0,Math.min(e,s.length-1)):i=e,l=0,c=0,f(),E(),updateThumbs()}e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");d(t.dataTransfer.files)}),t.addEventListener("change",e=>{d(e.target.files)});const h=210/297;let m=1,y=0,b=0,p=null,w=null;function E(){if(i<0||i>=s.length)return void a.clearRect(0,0,o.width,o.height);const e=u(i);if(!e)return;const t=o.width,n=o.height;a.fillStyle="#e0e0e0",a.fillRect(0,0,t,n);const r=20;let d,f;(t-40)/(n-40)>h?(f=(n-40)*m,d=f*h):(d=(t-40)*m,f=d/h);y=d>t?Math.max(-(d-t)-20,Math.min(r,y)):0,b=f>n?Math.max(-(f-n)-r,Math.min(r,b)):0;let g=d<t?(t-d)/2:y,E=f<n?(n-f)/2:b;a.fillStyle="white",a.save(),a.shadowColor="rgba(0,0,0,0.2)",a.shadowBlur=15,a.shadowOffsetX=5,a.shadowOffsetY=5,a.fillRect(g,E,d,f),a.shadowColor="transparent",a.restore(),a.save(),a.beginPath(),a.rect(g,E,d,f),a.clip(),a.translate(g,E);const I=d/8800;a.scale(I,I);const v=1/I,U=w&&w.index===i,L=p&&p.index===i;(U?w.data:L?p.data:e.data).forEach((e,t)=>{if(e.length>0){let n="black",r=v;if(U)n="purple";else if(L)n=t<p.splitPoint?"blue":"red";else{t>=l&&t<c&&(n="blue",r=3*v)}a.strokeStyle=n,a.lineWidth=r,a.beginPath(),a.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)a.lineTo(e[t].x,e[t].y);a.stroke()}}),a.restore()}window.addEventListener("resize",function(){const e=r.clientWidth,t=r.clientHeight;o.width=e,o.height=t,E()})});
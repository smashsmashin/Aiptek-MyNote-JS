const TOP_HEADER_SIZE=32,TOP_PACKET_SIZE=6,TOP_HEIGHT=12e3;function compressPointsWithHeader(e){const t=function(e){const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer}(e),n=new Uint8Array(t),r=new DataView(t,32),a=(t.byteLength-32)/6,o=[];let s=0,i=0,l=0,c=!1;const d=e=>new DataView(new ArrayBuffer(e)),u=n.slice(0,32);o.push(u.buffer);for(let e=0;e<a;e++){const t=6*e,n=r.getUint8(t),a=r.getInt16(t+1,!0),u=r.getInt16(t+3,!0),f=r.getUint8(t+5);if(0!=n){if(c){const e=a-s,t=u-i,r=f-l;if(Math.abs(e)<32&&Math.abs(t)<32&&Math.abs(r)<4){const n=d(2);let a=128;a|=(63&e)<<1,a|=t>>5&1,n.setUint8(0,a);let s=0;s|=(31&t)<<3,s|=7&r,n.setUint8(1,s),o.push(n.buffer)}else{const e=d(6);let t=127&n;128&n&&(t|=64),e.setUint8(0,t),e.setInt16(1,a,!0),e.setInt16(3,u,!0),e.setUint8(5,f),o.push(e.buffer)}}else{const e=d(6);let t=127&n;128&n&&(t|=64),e.setUint8(0,t),e.setInt16(1,a,!0),e.setInt16(3,u,!0),e.setUint8(5,f),o.push(e.buffer),c=!0}s=a,i=u,l=f}else{const e=d(1);e.setUint8(0,0),o.push(e.buffer),c=!1}}const f=o.reduce((e,t)=>e+t.byteLength,0),g=new Uint8Array(f);let h=0;for(const e of o)g.set(new Uint8Array(e),h),h+=e.byteLength;return function(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.byteLength;e++)t+=String.fromCharCode(n[e]);return btoa(t)}(g.buffer)}function decompressPointsWithHeader(e){const t=(e,t)=>{console.log(`getSignedValue: value=${e}, bitCount=${t}`);if(e&1<<t-1){const n=e-(1<<t);return console.log(`getSignedValue: result=${n}`),n}return console.log(`getSignedValue: result=${e}`),e},n=(e,t,n,r)=>{const a=new ArrayBuffer(6),o=new DataView(a);return o.setUint8(0,e),o.setInt16(1,t,!0),o.setInt16(3,n,!0),o.setUint8(5,r),a},r=function(e){const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer}(e),a=new DataView(r),o=[],s=new Uint8Array(r).slice(0,32).buffer;let i=32,l=0,c=0,d=0,u=0;for(;i<r.byteLength;){const e=a.getUint8(i),r=!(128&~e);let s,f,g,h,m=0;if(0===e){if(m=1,0===o.length){i+=m;continue}s=l,f=c,g=d,h=0}else if(r){m=2;const n=a.getUint8(i+1);s=l+t(e>>1&63,6),f=c+t((1&e)<<5|n>>3&31,6),g=d+t(7&n,3),h=135}else m=6,h=e,64&h&&(h|=128,h&=183),s=a.getInt16(i+1,!0),f=a.getInt16(i+3,!0),g=a.getUint8(i+5);l=s,c=f,d=g,u=h,o.push(n(h,s,f,g)),i+=m}const f=6*o.length,g=new Uint8Array(32+f);g.set(new Uint8Array(s),0);let h=32;for(const e of o)g.set(new Uint8Array(e),h),h+=6;return function(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.byteLength;e++)t+=String.fromCharCode(n[e]);return btoa(t)}(g.buffer)}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("drop-zone"),t=document.getElementById("file-input"),n=document.getElementById("page-list"),r=(document.getElementById("content-section"),document.getElementById("canvas-container")),a=document.getElementById("canvas"),o=a.getContext("2d"),s=(document.getElementById("selection-bar"),document.getElementById("min-thumb"),document.getElementById("max-thumb"),document.getElementById("title-bar"),document.getElementById("document-title"),document.getElementById("load-button"),document.getElementById("save-button"),document.getElementById("login-button"),[]);let i=-1,l=0,c=0;function d(e){if(0===e.length)return;const t=Array.from(e).filter(e=>e).map(e=>new Promise(t=>{const n=new FileReader;n.onload=n=>{s.push({name:e.name,fileBuffer:n.target.result,parsedData:null}),t()},n.readAsArrayBuffer(e)}));Promise.all(t).then(()=>{f(),-1===i&&s.length>0?g(0):g(i)})}function u(e){if(e<0||e>=s.length)return null;const t=s[e];if(t.parsedData)return t.parsedData;const n=function(e){const t=e.slice(0,32),n=new DataView(e),r=[];let a=[];for(let e=32;e+6<=n.byteLength;e+=6){const t=n.getUint8(e),o=n.getInt16(e+1,!0),s=n.getInt16(e+3,!0),i=n.getUint8(e+5);0!==t&&0===a.length&&r.push(a),a.push({x:s,y:12e3-o,p:i,penStatus:t}),0===t&&(a=[])}return{header:t,data:r.filter(e=>e.length>1)}}(t.fileBuffer);return t.parsedData=n,n}function f(){n.innerHTML="",closeContextMenu(),s.forEach((e,t)=>{const r=document.createElement("li");r.dataset.index=t,r.draggable=!0,t===i&&r.classList.add("active"),r.addEventListener("click",()=>g(t));const a=document.createElement("span");a.className="page-name",a.textContent=e.name;const o=document.createElement("button");o.className="context-menu-button",o.innerHTML="&#x22EE;",o.addEventListener("click",e=>{e.stopPropagation(),showContextMenu(e.currentTarget,t)}),r.appendChild(a),r.appendChild(o),n.appendChild(r)}),addDragDropListeners()}function g(e){e<0||e>=s.length?0===s.length?(i=-1,o.clearRect(0,0,a.width,a.height)):i=Math.max(0,Math.min(e,s.length-1)):i=e,l=0,c=0,f(),E(),updateThumbs()}e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");d(t.dataTransfer.files)}),t.addEventListener("change",e=>{d(e.target.files)});const h=210/297;let m=1,b=0,y=0,p=null,w=null;function E(){if(i<0||i>=s.length)return void o.clearRect(0,0,a.width,a.height);const e=u(i);if(!e)return;const t=a.width,n=a.height;o.fillStyle="#e0e0e0",o.fillRect(0,0,t,n);const r=20;let d,f;(t-40)/(n-40)>h?(f=(n-40)*m,d=f*h):(d=(t-40)*m,f=d/h);b=d>t?Math.max(-(d-t)-20,Math.min(r,b)):0,y=f>n?Math.max(-(f-n)-r,Math.min(r,y)):0;let g=d<t?(t-d)/2:b,E=f<n?(n-f)/2:y;o.fillStyle="white",o.save(),o.shadowColor="rgba(0,0,0,0.2)",o.shadowBlur=15,o.shadowOffsetX=5,o.shadowOffsetY=5,o.fillRect(g,E,d,f),o.shadowColor="transparent",o.restore(),o.save(),o.beginPath(),o.rect(g,E,d,f),o.clip(),o.translate(g,E);const I=d/8800;o.scale(I,I);const v=1/I,U=w&&w.index===i,L=p&&p.index===i;(U?w.data:L?p.data:e.data).forEach((e,t)=>{if(e.length>0){let n="black",r=v;if(U)n="purple";else if(L)n=t<p.splitPoint?"blue":"red";else{t>=l&&t<c&&(n="blue",r=3*v)}o.strokeStyle=n,o.lineWidth=r,o.beginPath(),o.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)o.lineTo(e[t].x,e[t].y);o.stroke()}}),o.restore()}window.addEventListener("resize",function(){const e=r.clientWidth,t=r.clientHeight;a.width=e,a.height=t,E()})});
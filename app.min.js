document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("drop-zone"),t=document.getElementById("file-input"),n=document.getElementById("page-list"),a=document.getElementById("content-section"),o=document.getElementById("canvas-container"),i=document.getElementById("canvas"),l=i.getContext("2d"),d=document.getElementById("selection-bar"),c=document.getElementById("min-thumb"),r=document.getElementById("max-thumb"),s=(document.getElementById("auth-container"),document.getElementById("user-profile")),u=document.getElementById("user-avatar"),p=document.getElementById("user-name"),m=document.getElementById("sign-out-button"),g=document.getElementById("cloud-actions"),h=document.querySelector(".g_id_signin"),f=document.getElementById("fetch-button"),y=document.getElementById("store-button"),v=[];let w=-1,E=0,b=0;function L(e){if(0===e.length)return;const t=Array.from(e).filter(e=>e);v.length;const n=t.map(e=>new Promise(t=>{const n=new FileReader;n.onload=n=>{const a=function(e){const t=new DataView(e),n=[];let a=[];for(let e=k;e+x<=t.byteLength;e+=x){const o=t.getUint8(e),i=t.getInt16(e+1,!0),l=t.getInt16(e+3,!0);0===a.length&&n.push(a),a.push({x:l,y:C-i}),0===o&&(a=[])}return n.filter(e=>e.length>0)}(n.target.result);v.push({name:e.name,data:a}),t()},n.readAsArrayBuffer(e)}));Promise.all(n).then(()=>{B(),-1===w&&v.length>0?T(0):T(w)})}e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");L(t.dataTransfer.files)}),t.addEventListener("change",e=>{L(e.target.files)});const k=32,x=6,C=12e3;function B(){n.innerHTML="",N(),v.forEach((e,t)=>{const a=document.createElement("li");a.dataset.index=t,a.draggable=!0,t===w&&a.classList.add("active"),a.addEventListener("click",()=>T(t));const o=document.createElement("span");o.className="page-name",o.textContent=e.name;const i=document.createElement("button");i.className="context-menu-button",i.innerHTML="&#x22EE;",i.addEventListener("click",e=>{e.stopPropagation(),function(e,t){N();const n=e.getBoundingClientRect();U=document.createElement("ul"),U.className="context-menu",U.style.position="absolute",U.style.top=`${n.bottom}px`,U.style.left=`${n.left}px`;const a=(e,t,n=!1)=>{const a=document.createElement("li");return a.textContent=e,n?a.classList.add("disabled"):a.addEventListener("click",e=>{e.stopPropagation(),t(),N()}),a},o=0===t,i=t===v.length-1,l=v[t],d=l.data.length,c=E>0&&E<d&&E===b;U.appendChild(a("Move Page Up",()=>_(t,t-1),o)),U.appendChild(a("Move Page Down",()=>_(t,t+1),i)),U.appendChild(document.createElement("hr")),U.appendChild(a("Merge Page Up",()=>z(t,"up"),o)),U.appendChild(a("Merge Page Down",()=>z(t,"down"),i)),U.appendChild(document.createElement("hr")),U.appendChild(a("Split Page",()=>function(e){const t=E,n=v[e];$={index:e,splitPoint:t},O();const a=`Split this page into two? Page "a" will have ${t} paths (blue), and page "b" will have ${n.data.length-t} paths (red).`;setTimeout(()=>{if(window.confirm(a)){const a=n.name,o={name:`${a}-a`,data:n.data.slice(0,t)},i={name:`${a}-b`,data:n.data.slice(t)};v.splice(e,1,o,i),$=null,T(e)}else $=null,O()},10)}(t),!c)),U.appendChild(document.createElement("hr")),U.appendChild(a("Rename Page",()=>J(t))),U.appendChild(document.createElement("hr")),U.appendChild(a("Delete Page",()=>j(t))),document.body.appendChild(U)}(e.currentTarget,t)}),a.appendChild(o),a.appendChild(i),n.appendChild(a)}),function(){const e=Array.from(n.querySelectorAll("li")),t=()=>{e.forEach(e=>e.classList.remove("drop-indicator-top","drop-indicator-bottom"))};e.forEach(e=>{e.addEventListener("dragstart",e=>{e.target.classList.contains("context-menu-button")?e.preventDefault():(H=parseInt(e.currentTarget.dataset.index,10),setTimeout(()=>e.currentTarget.classList.add("dragging"),0),e.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{t(),e.classList.remove("dragging"),H=null}),e.addEventListener("dragover",n=>{n.preventDefault();const a=e.getBoundingClientRect(),o=n.clientY>a.top+a.height/2;t(),o?e.classList.add("drop-indicator-bottom"):e.classList.add("drop-indicator-top")}),e.addEventListener("dragleave",()=>{}),e.addEventListener("drop",n=>{n.preventDefault(),n.stopPropagation();const a=e.getBoundingClientRect(),o=n.clientY>a.top+a.height/2;let i=parseInt(e.dataset.index,10);t(),null!==H&&H!==i&&(o&&i++,H<i&&i--,_(H,i))})}),n.addEventListener("dragend",t),n.addEventListener("dragleave",e=>{e.target===n&&t()})}()}function T(e){e<0||e>=v.length?0===v.length?(w=-1,l.clearRect(0,0,i.width,i.height)):w=Math.max(0,Math.min(e,v.length-1)):w=e,E=0,b=0,B(),O(),W()}const I=210/297;let M=1,P=0,A=0,D=!1,S={x:0,y:0},$=null,R=null;function Y(){const e=o.clientWidth,t=o.clientHeight;i.width=e,i.height=t,O()}function O(){if(w<0||w>=v.length)return void l.clearRect(0,0,i.width,i.height);const e=v[w],t=i.width,n=i.height;l.fillStyle="#e0e0e0",l.fillRect(0,0,t,n);const a=20;let o,d;(t-40)/(n-40)>I?(d=(n-40)*M,o=d*I):(o=(t-40)*M,d=o/I);P=o>t?Math.max(-(o-t)-20,Math.min(a,P)):0,A=d>n?Math.max(-(d-n)-a,Math.min(a,A)):0;let c=o<t?(t-o)/2:P,r=d<n?(n-d)/2:A;l.fillStyle="white",l.save(),l.shadowColor="rgba(0,0,0,0.2)",l.shadowBlur=15,l.shadowOffsetX=5,l.shadowOffsetY=5,l.fillRect(c,r,o,d),l.shadowColor="transparent",l.restore(),l.save(),l.beginPath(),l.rect(c,r,o,d),l.clip(),l.translate(c,r);const s=o/8800;l.scale(s,s);const u=1/s,p=R&&R.index===w,m=$&&$.index===w;p||m?(p?R:e).data.forEach((e,t)=>{if(e.length>0){if(p)l.strokeStyle="purple";else{const e=$.splitPoint;l.strokeStyle=t<e?"blue":"red"}l.lineWidth=u,l.beginPath(),l.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)l.lineTo(e[t].x,e[t].y);l.stroke()}}):e.data.forEach((e,t)=>{if(e.length>0){const n=t>=E&&t<b;l.strokeStyle=n?"blue":"black",l.lineWidth=n?3*u:u,l.beginPath(),l.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)l.lineTo(e[t].x,e[t].y);l.stroke()}}),l.restore()}window.addEventListener("resize",Y);let U=null;function N(){U&&(U.remove(),U=null)}function W(){if(w<0)return;const e=v[w].data.length;if(0===e)return c.style.top="0%",void(r.style.top="0%");const t=E/e*100,n=b/e*100;c.style.top=`${t}%`,r.style.top=`${n}%`}window.addEventListener("click",e=>{!U||U.contains(e.target)||e.target.classList.contains("context-menu-button")||N()}),a.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey){const t=.05,n=e.deltaY<0?1:-1,o=Math.exp(n*t),i=a.getBoundingClientRect(),l=e.clientX-i.left,d=e.clientY-i.top,c=(l-P)/M,r=(d-A)/M;M*=o;P+=((l-P)/M-c)*M,A+=((d-A)/M-r)*M}else e.shiftKey?P-=e.deltaY:A-=e.deltaY;O()}),o.addEventListener("mousedown",e=>{D=!0,S.x=e.clientX,S.y=e.clientY,o.style.cursor="grabbing"}),o.addEventListener("mouseup",()=>{D=!1,o.style.cursor="grab"}),o.addEventListener("mouseleave",()=>{D=!1,o.style.cursor="default"}),o.addEventListener("mousemove",e=>{if(D){const t=e.clientX-S.x,n=e.clientY-S.y;P+=t,A+=n,S.x=e.clientX,S.y=e.clientY,O()}});let q=null;function K(e){q=e.target===c?c:r,document.addEventListener("mousemove",F),document.addEventListener("mouseup",V)}function V(){q=null,document.removeEventListener("mousemove",F),document.removeEventListener("mouseup",V)}function F(e){if(!q||w<0)return;const t=v[w].data.length;if(t<=1)return;const n=d.getBoundingClientRect(),a=e.clientY-n.top,o=Math.max(0,Math.min(100,a/n.height*100)),i=Math.round(t*o/100);q===c?E=Math.min(i,b):b=Math.max(i,E),E=Math.max(0,E),b=Math.min(t,b),W(),O()}function X(e){const t=e.target;let n=0;if("ArrowUp"===e.key?n=-1:"ArrowDown"===e.key?n=1:"PageUp"===e.key?n=-100:"PageDown"===e.key&&(n=100),0===n||w<0)return;e.preventDefault();const a=v[w].data.length;t===c?E=Math.max(0,Math.min(E+n,b)):b=Math.max(E,Math.min(b+n,a)),W(),O()}function _(e,t){if(t<0||t>=v.length||e===t)return;const[n]=v.splice(e,1);v.splice(t,0,n),w===e?w=t:w>e&&w<=t?w--:w<e&&w>=t&&w++,B()}function z(e,t){const n="up"===t?e-1:e+1;if(n<0||n>=v.length)return;const a="up"===t?v[n]:v[e],o="up"===t?v[e]:v[n],i=Math.min(e,n),l=`${a.name}-${o.name}`,d=a.data.concat(o.data);R={index:i,data:d},T(i);const c=`Are you sure you want to merge "${a.name}" and "${o.name}" into a new page named "${l}"?`;setTimeout(()=>{if(window.confirm(c)){const e={name:l,data:d};v.splice(i,2,e),R=null,T(i)}else R=null,O()},10)}c.addEventListener("mousedown",K),r.addEventListener("mousedown",K),c.addEventListener("keydown",X),r.addEventListener("keydown",X);let H=null;function j(e){if(e<0||e>=v.length)return!1;const t=v[e].name;return!!window.confirm(`Are you sure you want to delete the page "${t}"?`)&&(v.splice(e,1),w===e?T(Math.max(0,e-1)):w>e?T(w-1):B(),!0)}function J(e){N();const t=n.querySelector(`li[data-index='${e}']`);if(!t)return;const a=t.querySelector(".page-name"),o=v[e].name,i=document.createElement("input");i.type="text",i.value=o,i.className="page-name-input",i.style.width="100%",i.addEventListener("blur",function t(){i.removeEventListener("blur",t);const n=i.value.trim();n&&n!==o&&(v[e].name=n);B()}),i.addEventListener("keydown",e=>{"Enter"===e.key?i.blur():"Escape"===e.key&&(i.value=o,i.blur())}),a.replaceWith(i),i.focus(),i.select()}window.addEventListener("keydown",function(e){if(!("Delete"!==e.key||w<0))if(E<b){if(window.confirm(`Are you sure you want to delete ${b-E} selected path(s)?`)){const e=v[w],t=b-E;e.data.splice(E,t),b=E,0===e.data.length&&j(w)||(W(),O())}}else j(w)}),window.addEventListener("keydown",e=>{e.ctrlKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),function(){const e=document.createElement("iframe");e.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(e);const t=e.contentWindow.document;t.write("<!DOCTYPE html><html><head><title>Print</title><style>\n            @page { size: A4 portrait; margin: 0; }\n            body { margin: 0; }\n            .page-container { width: 210mm; height: 297mm; page-break-after: always; overflow: hidden; }\n            .page-container:last-child { page-break-after: avoid; }\n            canvas { width: 100%; height: 100%; }\n        </style></head><body></body></html>");const n=t.body;v.forEach(e=>{const a=t.createElement("div");a.className="page-container";const o=t.createElement("canvas"),i=o.getContext("2d"),l=2480;o.width=l,o.height=3508,i.fillStyle="white",i.fillRect(0,0,l,3508);const d=l/8800;i.scale(d,d),i.lineWidth=5,i.strokeStyle="black",e.data.forEach(e=>{if(e.length>0){i.beginPath(),i.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)i.lineTo(e[t].x,e[t].y);i.stroke()}}),a.appendChild(o),n.appendChild(a)}),t.close(),e.contentWindow.focus(),e.contentWindow.print(),setTimeout(()=>document.body.removeChild(e),500)}()):"F2"===e.key&&-1!==w&&(e.preventDefault(),J(w))}),window.onSignIn=function(e){const t=e.credential,n=JSON.parse(atob(t.split(".")[1]));u.src=n.picture,p.textContent=n.name,h.style.display="none",s.style.display="block",g.style.display="block"},m.addEventListener("click",function(){google.accounts.id.disableAutoSelect(),h.style.display="block",s.style.display="none",g.style.display="none"});const G="191122390b2119282b1a69752f1c1f2a0c6e2f2b146d3b0e692e2e616133140f39210e7569373f".match(/.{1,2}/g).map(e=>parseInt(e,16)).map(e=>{return(t="ab313819c1285b48eb405b635b47b8ec",t.split("").map(e=>e.charCodeAt(0))).reduce((e,t)=>e^t,e);var t}).map(e=>String.fromCharCode(e)).join(""),Q="414398931859-h04be241u8er4lgiun26qpavdjrnqecc.apps.googleusercontent.com",Z="https://www.googleapis.com/auth/drive.file";let ee,te=!1,ne=!1;async function ae(){await gapi.client.init({apiKey:G,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),te=!0}function oe(e){null===gapi.client.getToken()?(ee.callback=t=>{if(void 0!==t.error)throw t;"fetch"===e?ie():"store"===e&&de()},google.accounts.oauth2.hasGrantedAllScopes(gapi.client.getToken(),Z)?"fetch"===e?ie():"store"===e&&de():ee.requestAccessToken({prompt:"consent"})):"fetch"===e?ie():"store"===e&&de()}function ie(){const e=new google.picker.View(google.picker.ViewId.DOCS);e.setMimeTypes("application/octet-stream");(new google.picker.PickerBuilder).setAppId(Q.split(".")[0]).setOAuthToken(gapi.client.getToken().access_token).addView(e).setDeveloperKey(G).setCallback(le).build().setVisible(!0)}async function le(e){if(e.action===google.picker.Action.PICKED){const t=e.docs[0].id,n=e.docs[0].name,a=await gapi.client.drive.files.get({fileId:t,alt:"media"}),o=new Blob([a.body],{type:"application/octet-stream"});L([new File([o],n)])}}async function de(){if(w<0||0===v.length)return void alert("No page selected to store.");const e=v[w],t=function(e){const t=new ArrayBuffer(k),n=[];e.forEach(e=>{e.length>0&&e.forEach((t,a)=>{const o=new ArrayBuffer(x),i=new DataView(o),l=a===e.length-1?0:1;i.setUint8(0,l),i.setInt16(1,C-t.y,!0),i.setInt16(3,t.x,!0),n.push(o)})});const a=k+n.length*x,o=new Uint8Array(a);o.set(new Uint8Array(t),0);let i=k;return n.forEach(e=>{o.set(new Uint8Array(e),i),i+=x}),new Blob([o],{type:"application/octet-stream"})}(e.data),n=e.name,a={name:n,mimeType:"application/octet-stream"},o=new FormData;o.append("metadata",new Blob([JSON.stringify(a)],{type:"application/json"})),o.append("file",t);const i=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:new Headers({Authorization:"Bearer "+gapi.client.getToken().access_token}),body:o});i.ok?alert(`File "${n}" uploaded successfully.`):alert(`Error uploading file: ${i.statusText}`)}window.gapiLoaded=function(){gapi.load("client:picker",ae)},window.gisLoaded=function(){ee=google.accounts.oauth2.initTokenClient({client_id:Q,scope:Z,callback:""}),ne=!0},f.addEventListener("click",()=>oe("fetch")),y.addEventListener("click",()=>oe("store")),Y(),o.style.cursor="grab"});
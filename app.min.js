document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("drop-zone"),t=document.getElementById("file-input"),n=document.getElementById("page-list"),o=document.getElementById("index-section"),a=document.getElementById("content-section"),s=document.getElementById("canvas-container"),i=document.getElementById("canvas"),l=i.getContext("2d"),r=document.getElementById("selection-bar"),c=document.getElementById("min-thumb"),d=document.getElementById("max-thumb"),u=document.getElementById("selection-indicator"),h=document.getElementById("mobile-selection-controls"),m=document.getElementById("min-handle"),p=document.getElementById("max-handle"),f=(document.getElementById("title-bar"),document.getElementById("menu-button")),y=document.getElementById("document-title"),g=document.getElementById("rename-button"),w=document.getElementById("load-button"),v=document.getElementById("save-button"),E=document.getElementById("login-button"),b=document.getElementById("user-menu"),L=document.getElementById("user-avatar"),x=document.getElementById("user-dropdown"),D=document.getElementById("switch-user-button"),C=document.getElementById("logout-button"),k=document.getElementById("notification-area"),A=document.getElementById("dropdown-load-button"),I=document.getElementById("dropdown-save-button");let B;function U(e,t=3e3){k.textContent=e,k.style.display="block",clearTimeout(B),B=setTimeout(()=>{k.style.display="none"},t)}const M=[];let P=-1,T=0,$=0;function Y(e){if(0===e.length)return;const t=Array.from(e).map(e=>new Promise((t,n)=>{const o=new FileReader;o.onload=n=>{const o=n.target.result;if(o.byteLength<X)return console.error(`File ${e.name} is smaller than the minimum header size.`),t(null);M.push({name:e.name,rawData:o,paths:null}),t(!0)},o.onerror=e=>n(e),o.readAsArrayBuffer(e)}));Promise.all(t).then(()=>{N(),-1===P&&M.length>0?F(0):F(P)})}e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragover");Y(t.dataTransfer.files)}),t.addEventListener("change",e=>{Y(e.target.files)});const X=32,R=6,S=12e3;function W(e){if(e.paths)return;const t=new DataView(e.rawData),n=[];let o=[],a=-1;for(let e=X;e+R<=t.byteLength;e+=R){-1===a&&(a=e);const s=t.getUint8(e),i=t.getInt16(e+1,!0),l=t.getInt16(e+3,!0);if(o.push({x:l,y:S-i}),0===s){const t=e-a+R;n.push({points:o,offset:a,length:t}),o=[],a=-1}}e.paths=n}function N(){n.innerHTML="",ne(),M.forEach((e,t)=>{const o=document.createElement("li");o.dataset.index=t,o.draggable=!0,t===P&&o.classList.add("active"),o.addEventListener("click",()=>F(t));const a=document.createElement("span");a.className="page-name",a.textContent=e.name;const s=document.createElement("button");s.className="context-menu-button",s.innerHTML="&#x22EE;",s.addEventListener("click",e=>{e.stopPropagation(),function(e,t){ne();const n=e.getBoundingClientRect();te=document.createElement("ul"),te.className="context-menu",te.style.position="absolute",te.style.top=`${n.bottom}px`,te.style.left=`${n.left}px`;const o=(e,t,n=!1)=>{const o=document.createElement("li");return o.textContent=e,n?o.classList.add("disabled"):o.addEventListener("click",e=>{e.stopPropagation(),t(),ne()}),o},a=0===t,s=t===M.length-1,i=M[t];W(i);const l=i.paths?i.paths.length:0,r=T>0&&T<l&&T===$;te.appendChild(o("Move Page Up",()=>we(t,t-1),a)),te.appendChild(o("Move Page Down",()=>we(t,t+1),s)),te.appendChild(document.createElement("hr")),te.appendChild(o("Merge Page Up",()=>ve(t,"up"),a)),te.appendChild(o("Merge Page Down",()=>ve(t,"down"),s)),te.appendChild(document.createElement("hr")),te.appendChild(o("Split Page",()=>function(e){const t=M[e],n=T;J={index:e,splitPoint:n},ee();const o=`Split this page into two? Page "a" will have ${n} paths (blue), and page "b" will have ${t.paths.length-n} paths (red).`;setTimeout(()=>{const a=window.confirm(o);if(J=null,a){const o=t.name.replace(/.top$/i,""),a=t.paths.slice(0,n),s=t.paths.slice(n),i=e=>{if(0===e.length)return null;const n=e.map(e=>t.rawData.slice(e.offset,e.offset+e.length)),o=n.reduce((e,t)=>e+t.byteLength,0),a=new ArrayBuffer(X+o),s=new Uint8Array(a);s.set(new Uint8Array(t.rawData.slice(0,X)),0);let i=X;for(const e of n)s.set(new Uint8Array(e),i),i+=e.byteLength;return a},l=i(a),r=i(s),c=[];l&&c.push({name:`${o}-a.top`,rawData:l,paths:null}),r&&c.push({name:`${o}-b.top`,rawData:r,paths:null}),c.length>0?(M.splice(e,1,...c),F(e)):(M.splice(e,1),F(Math.max(0,e-1)))}else ee()},10)}(t),!r)),te.appendChild(document.createElement("hr")),te.appendChild(o("Rename Page",()=>Le(t))),te.appendChild(document.createElement("hr")),te.appendChild(o("Delete Page",()=>be(t))),document.body.appendChild(te)}(e.currentTarget,t)}),o.appendChild(a),o.appendChild(s),n.appendChild(o)}),function(){const e=Array.from(n.querySelectorAll("li")),t=()=>{e.forEach(e=>e.classList.remove("drop-indicator-top","drop-indicator-bottom"))};e.forEach(e=>{e.addEventListener("dragstart",e=>{if(e.target.classList.contains("context-menu-button"))return void e.preventDefault();const t=e.currentTarget;Ee=parseInt(t.dataset.index,10),setTimeout(()=>t.classList.add("dragging"),0),e.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",()=>{t(),e.classList.remove("dragging"),Ee=null}),e.addEventListener("dragover",n=>{n.preventDefault();const o=e.getBoundingClientRect(),a=n.clientY>o.top+o.height/2;t(),a?e.classList.add("drop-indicator-bottom"):e.classList.add("drop-indicator-top")}),e.addEventListener("dragleave",()=>{}),e.addEventListener("drop",n=>{n.preventDefault(),n.stopPropagation();const o=e.getBoundingClientRect(),a=n.clientY>o.top+o.height/2;let s=parseInt(e.dataset.index,10);t(),null!==Ee&&Ee!==s&&(a&&s++,Ee<s&&s--,we(Ee,s))})}),n.addEventListener("dragend",t),n.addEventListener("dragleave",e=>{e.target===n&&t()})}()}function F(e){if(e<0||e>=M.length){if(0===M.length)return P=-1,l.clearRect(0,0,i.width,i.height),N(),void ae();e=Math.max(0,Math.min(e,M.length-1))}P=e;W(M[P]),T=0,$=0,N(),ee(),ae()}const O=210/297;let q=1,V=0,z=0,K=!1,H={x:0,y:0},j=!1,G={x:0,y:0},_=0,J=null,Q=null;function Z(){const e=s.clientWidth,t=s.clientHeight;i.width=e,i.height=t,ee(),i.style.visibility="visible"}function ee(){if(P<0||P>=M.length)return void l.clearRect(0,0,i.width,i.height);const e=M[P],t=i.width,n=i.height;l.fillStyle="#e0e0e0",l.fillRect(0,0,t,n);const o=20;let a,s;(t-40)/(n-40)>O?(s=(n-40)*q,a=s*O):(a=(t-40)*q,s=a/O);V=a>t?Math.max(-(a-t)-20,Math.min(o,V)):0,z=s>n?Math.max(-(s-n)-o,Math.min(o,z)):0;let r=a<t?(t-a)/2:V,c=s<n?(n-s)/2:z;l.fillStyle="white",l.save(),l.shadowColor="rgba(0,0,0,0.2)",l.shadowBlur=15,l.shadowOffsetX=5,l.shadowOffsetY=5,l.fillRect(r,c,a,s),l.shadowColor="transparent",l.restore(),l.save(),l.beginPath(),l.rect(r,c,a,s),l.clip(),l.translate(r,c);const d=a/8800;l.scale(d,d);const u=1/d,h=Q&&Q.index===P,m=J&&J.index===P;(e.paths||[]).forEach((e,t)=>{if(e.points.length>0){let n="black";const o=t>=T&&t<$;if(m&&J.index===P){n=t<J.splitPoint?"blue":"red"}else h&&Q.index===P?n="purple":o&&(n="blue");l.strokeStyle=n,l.lineWidth=o?3*u:u,l.beginPath(),l.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)l.lineTo(e.points[t].x,e.points[t].y);l.stroke()}}),l.restore()}new ResizeObserver(Z).observe(s);let te=null;function ne(){te&&(te.remove(),te=null)}window.addEventListener("click",e=>{!te||te.contains(e.target)||e.target.classList.contains("context-menu-button")||ne(),"block"!==x.style.display||b.contains(e.target)||(x.style.display="none")});const oe=async()=>{if(!await Ue())return;const e=$e(De,"users",Be.uid,"documents"),t=await Ye(e);if(t.empty)return void U("No saved documents found.");const n=t.docs.map(e=>e.id),o=prompt("Enter the name of the document to load:\n\n"+n.join("\n"));if(o&&n.includes(o)){const e=w.querySelector("svg");try{w.disabled=!0,e.classList.add("spinner");const t=Me(De,"users",Be.uid,"documents",o),n=await Te(t);if(n.exists()){const e=n.data().pages.map(e=>{const t=atob(e.data),n=new ArrayBuffer(t.length),o=new Uint8Array(n);for(let e=0;e<t.length;e++)o[e]=t.charCodeAt(e);const a=function(e){const t=(e,t)=>e&1<<t-1?e-(1<<t):e,n=(e,t,n,o)=>{const a=new ArrayBuffer(6),s=new DataView(a);return s.setUint8(0,e),s.setInt16(1,t,!0),s.setInt16(3,n,!0),s.setUint8(5,o),a},o=new DataView(e),a=[],s=32,i=new Uint8Array(e).slice(0,s).buffer;let l=s,r=0,c=0,d=0;for(;l<e.byteLength;){const e=o.getUint8(l),s=!(128&~e);let i,u,h,m,p=0;if(0===e){if(p=1,0===a.length){l+=p;continue}i=r,u=c,h=d,m=0}else if(s){p=2;const n=o.getUint8(l+1);i=r+t(e>>1&63,6),u=c+t((1&e)<<5|n>>3&31,6),h=d+t(7&n,3),m=135}else p=6,m=e,64&m&&(m|=128),m&=191,i=o.getInt16(l+1,!0),u=o.getInt16(l+3,!0),h=o.getUint8(l+5);r=i,c=u,d=h,a.push(n(m,i,u,h)),l+=p}const u=6*a.length,h=new Uint8Array(s+u);h.set(new Uint8Array(i),0);let m=s;for(const e of a)h.set(new Uint8Array(e),m),m+=6;return h.buffer}(n);return{name:e.name,rawData:a,paths:null}});if(0===M.length)M.push(...e),y.textContent=o,N(),F(0);else{if(confirm("Do you want to replace the current pages or append the new ones?"))M.length=0,M.push(...e),y.textContent=o,N(),F(0);else{const t=M.length;M.push(...e);confirm(`Document loaded. Keep current name "${y.textContent}" or use new name "${o}"?`)&&(y.textContent=o),N(),F(t)}}}else U("Document not found.")}catch(e){console.error("Error loading document:",e),U("Failed to load document. Please check the console for details.")}finally{w.disabled=!1,e.classList.remove("spinner")}}else o&&alert(`Document "${o}" not found.`)};function ae(){if(P<0)return;const e=M[P],t=e.paths?e.paths.length:0;if(0===t)return c.style.top="0%",d.style.top="0%",u.style.top="0%",void(u.style.height="0%");const n=T/t*100,o=$/t*100;c.style.top=`${n}%`,d.style.top=`${o}%`,u.style.top=`${n}%`,u.style.height=o-n+"%"}a.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey){const t=.05,n=e.deltaY<0?1:-1,o=Math.exp(n*t),s=a.getBoundingClientRect(),i=e.clientX-s.left,l=e.clientY-s.top,r=(i-V)/q,c=(l-z)/q;q*=o;V+=((i-V)/q-r)*q,z+=((l-z)/q-c)*q}else e.shiftKey?V-=e.deltaY:z-=e.deltaY;ee()}),s.addEventListener("mousedown",e=>{K=!0,H.x=e.clientX,H.y=e.clientY,s.style.cursor="grabbing"}),s.addEventListener("mouseup",()=>{K=!1,s.style.cursor="grab"}),s.addEventListener("mouseleave",()=>{K=!1,s.style.cursor="default"}),s.addEventListener("mousemove",e=>{if(K){const t=e.clientX-H.x,n=e.clientY-H.y;V+=t,z+=n,H.x=e.clientX,H.y=e.clientY,ee()}}),s.addEventListener("touchstart",e=>{e.preventDefault(),j=!0,1===e.touches.length?(G.x=e.touches[0].clientX,G.y=e.touches[0].clientY):2===e.touches.length&&(_=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY))}),s.addEventListener("touchend",e=>{e.preventDefault(),e.touches.length<2&&(_=0),1===e.touches.length?(G.x=e.touches[0].clientX,G.y=e.touches[0].clientY):0===e.touches.length&&(j=!1)}),s.addEventListener("touchmove",e=>{if(e.preventDefault(),j){if(1===e.touches.length){const t=e.touches[0].clientX-G.x,n=e.touches[0].clientY-G.y;V+=t,z+=n,G.x=e.touches[0].clientX,G.y=e.touches[0].clientY}else if(2===e.touches.length&&_>0){const t=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY),n=t/_,o=s.getBoundingClientRect(),a=(e.touches[0].clientX+e.touches[1].clientX)/2-o.left,i=(e.touches[0].clientY+e.touches[1].clientY)/2-o.top,l=(a-V)/q,r=(i-z)/q;q*=n;V+=((a-V)/q-l)*q,z+=((i-z)/q-r)*q,_=t}ee()}});let se,ie=null;function le(e){ie=e.target===c?c:d,document.addEventListener("mousemove",ce),document.addEventListener("mouseup",re)}function re(){ie=null,document.removeEventListener("mousemove",ce),document.removeEventListener("mouseup",re)}function ce(e){if(!ie||P<0)return;const t=M[P],n=t.paths?t.paths.length:0;if(n<=1)return;const o=r.getBoundingClientRect(),a=e.clientY-o.top,s=Math.max(0,Math.min(100,a/o.height*100)),i=Math.round(n*s/100);ie===c?T=Math.min(i,$):$=Math.max(i,T),T=Math.max(0,T),$=Math.min(n,$),ae(),ee()}function de(e){const t=e.target;let n=0;if("ArrowUp"===e.key?n=-1:"ArrowDown"===e.key?n=1:"PageUp"===e.key?n=-100:"PageDown"===e.key&&(n=100),0===n||P<0)return;e.preventDefault();const o=M[P],a=o.paths?o.paths.length:0;t===c?T=Math.max(0,Math.min(T+n,$)):$=Math.max(T,Math.min($+n,a)),ae(),ee()}c.addEventListener("mousedown",le),d.addEventListener("mousedown",le),c.addEventListener("keydown",de),d.addEventListener("keydown",de);let ue,he=null,me={x:0,y:0};function pe(e=5e3){window.innerWidth>768||(h.style.display="flex",m.style.display="block",p.style.display="block",clearTimeout(se),e>0&&(se=setTimeout(()=>{h.style.display="none"},e)))}function fe(e){e.preventDefault(),e.stopPropagation(),he=e.currentTarget===m?"min":"max",me.x=e.touches[0].clientX,me.y=e.touches[0].clientY,clearTimeout(se),"min"===he?p.style.display="none":m.style.display="none"}function ye(e){if(!he||P<0)return;e.preventDefault(),e.stopPropagation();const t=M[P],n=t.paths?t.paths.length:0;if(n<=1)return;const o=e.touches[0].clientX-me.x,a=e.touches[0].clientY-me.y,s=1+Math.abs(o)/20,i=Math.round(a/5*s);"min"===he?T=Math.max(0,Math.min(T+i,$)):$=Math.max(T,Math.min($+i,n)),ae(),ee(),me.x=e.touches[0].clientX,me.y=e.touches[0].clientY}function ge(e){e.preventDefault(),e.stopPropagation(),he=null,pe()}function we(e,t){if(t<0||t>=M.length||e===t)return;const[n]=M.splice(e,1);M.splice(t,0,n),P===e?P=t:P>e&&P<=t?P--:P<e&&P>=t&&P++,N()}function ve(e,t){const n="up"===t?e-1:e+1;if(n<0||n>=M.length)return;const o="up"===t?M[n]:M[e],a="up"===t?M[e]:M[n],s=Math.min(e,n);W(o),W(a);const i=(o.paths||[]).concat(a.paths||[]);Q={index:s,data:{paths:i}},ee();const l=`Are you sure you want to merge "${o.name}" and "${a.name}"?`;setTimeout(async()=>{const e=window.confirm(l);if(Q=null,e){let e=o.rawData.slice(0,X);if(String.fromCharCode.apply(null,new Uint8Array(o.rawData.slice(0,X)))!==String.fromCharCode.apply(null,new Uint8Array(a.rawData.slice(0,X)))){let t=prompt(`The headers of "${o.name}" and "${a.name}" are different. Which header do you want to use? Type 'top' or 'bottom'.`,"top");for(;t&&"top"!==t.toLowerCase()&&"bottom"!==t.toLowerCase();)t=prompt("Invalid choice. Please type 'top' or 'bottom'.","top");t&&"bottom"===t.toLowerCase()&&(e=a.rawData.slice(0,X))}const t=o.rawData.slice(X),n=a.rawData.slice(X),i=new ArrayBuffer(X+t.byteLength+n.byteLength),l=new Uint8Array(i);l.set(new Uint8Array(e),0),l.set(new Uint8Array(t),X),l.set(new Uint8Array(n),X+t.byteLength);const r={name:`${o.name.replace(/.top$/i,"")}-${a.name.replace(/.top$/i,"")}.top`,rawData:i,paths:null};M.splice(s,2,r),F(s)}else ee()},10)}s.addEventListener("touchstart",e=>{if(window.innerWidth<=768){if(e.target.closest("#mobile-selection-controls"))return;ue=setTimeout(()=>{pe()},1e3)}}),s.addEventListener("touchmove",()=>{clearTimeout(ue)}),s.addEventListener("touchend",()=>{clearTimeout(ue)}),m.addEventListener("touchstart",fe),m.addEventListener("touchmove",ye),m.addEventListener("touchend",ge),p.addEventListener("touchstart",fe),p.addEventListener("touchmove",ye),p.addEventListener("touchend",ge);let Ee=null;function be(e){if(e<0||e>=M.length)return!1;const t=M[e].name;return!!window.confirm(`Are you sure you want to delete the page "${t}"?`)&&(M.splice(e,1),P===e?F(Math.max(0,e-1)):P>e?F(P-1):N(),!0)}function Le(e){ne();const t=n.querySelector(`li[data-index='${e}']`);if(!t)return;const o=t.querySelector(".page-name"),a=M[e].name,s=document.createElement("input");s.type="text",s.value=a,s.className="page-name-input",s.style.width="100%",s.addEventListener("blur",function t(){s.removeEventListener("blur",t);const n=s.value.trim();n&&n!==a&&(M[e].name=n);N()}),s.addEventListener("keydown",e=>{"Enter"===e.key?s.blur():"Escape"===e.key&&(s.value=a,s.blur())}),o.replaceWith(s),s.focus(),s.select()}window.addEventListener("keydown",function(e){if("Delete"!==e.key||P<0)return;const t=M[P];if(t)if(T<$){if(window.confirm(`Are you sure you want to delete ${$-T} selected path(s)?`)){const e=new Set(t.paths.slice(T,$)),n=t.paths.filter(t=>!e.has(t));if(0===n.length)be(P);else{const e=n.reduce((e,t)=>e+t.length,0),o=new ArrayBuffer(X+e),a=new Uint8Array(o);a.set(new Uint8Array(t.rawData.slice(0,X)),0);let s=X;n.forEach(e=>{const n=t.rawData.slice(e.offset,e.offset+e.length);a.set(new Uint8Array(n),s),s+=n.byteLength}),t.rawData=o,t.paths=null,$=T,F(P)}}}else be(P)}),window.addEventListener("keydown",e=>{e.ctrlKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),function(){const e=document.createElement("iframe");e.style.cssText="position:absolute;width:0;height:0;border:0;",document.body.appendChild(e);const t=e.contentWindow.document;t.write("<!DOCTYPE html><html><head><title>Print</title><style>\n            @page { size: A4 portrait; margin: 0; }\n            body { margin: 0; }\n            .page-container { width: 210mm; height: 297mm; page-break-after: always; overflow: hidden; }\n            .page-container:last-child { page-break-after: avoid; }\n            canvas { width: 100%; height: 100%; }\n        </style></head><body></body></html>");const n=t.body;M.forEach(e=>{const o=t.createElement("div");o.className="page-container";const a=t.createElement("canvas"),s=a.getContext("2d"),i=2480;a.width=i,a.height=3508,s.fillStyle="white",s.fillRect(0,0,i,3508);const l=i/8800;s.scale(l,l),s.lineWidth=5,s.strokeStyle="black",W(e),(e.paths||[]).forEach(e=>{if(e.points.length>0){s.beginPath(),s.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)s.lineTo(e.points[t].x,e.points[t].y);s.stroke()}}),o.appendChild(a),n.appendChild(o)}),t.close(),e.contentWindow.focus(),e.contentWindow.print(),setTimeout(()=>document.body.removeChild(e),500)}()):"F2"===e.key&&-1!==P&&(e.preventDefault(),Le(P))});const{auth:xe,db:De,GoogleAuthProvider:Ce,signInWithPopup:ke,onAuthStateChanged:Ae,signOut:Ie}=window.firebase;let Be=null;async function Ue(){if(Be)return!0;try{const e=new Ce;return await ke(xe,e),!!xe.currentUser}catch(e){return console.error("Authentication failed:",e),U("Login failed. Please check the console for details."),!1}}Ae(xe,e=>{Be=e,e?(E.style.display="none",b.style.display="block",L.src=e.photoURL,y.textContent=e.displayName?`${e.displayName}'s Document`:"Untitled Document"):(E.style.display="",b.style.display="none",y.textContent="Untitled Document")}),E.addEventListener("click",async()=>{try{const e=new Ce;await ke(xe,e)}catch(e){console.error("Authentication failed:",e),U("Login failed. Please check the console for details.")}}),C.addEventListener("click",async()=>{await Ie(xe),x.style.display="none"}),D.addEventListener("click",async()=>{try{const e=new Ce;e.setCustomParameters({prompt:"select_account"}),await ke(xe,e)}catch(e){console.error("Authentication failed:",e),U("Login failed. Please check the console for details.")}finally{x.style.display="none"}}),L.addEventListener("click",()=>{x.style.display="block"===x.style.display?"none":"block"});const{doc:Me,setDoc:Pe,getDoc:Te,collection:$e,getDocs:Ye}=window.firebase,Xe=async()=>{if(!await Ue())return;if(0===M.length)return void U("There are no pages to save.");const e=prompt("Enter a name for your document:",y.textContent);if(!e)return;const t=v.querySelector("svg");try{v.disabled=!0,t.classList.add("spinner");const n=M.map(async e=>{const t=function(e){const t=32,n=new Uint8Array(e),o=new DataView(e,t),a=(e.byteLength-t)/6,s=[];let i=0,l=0,r=0,c=!1;const d=e=>new DataView(new ArrayBuffer(e)),u=n.slice(0,t);s.push(u.buffer);for(let e=0;e<a;e++){const t=6*e,n=o.getUint8(t),a=o.getInt16(t+1,!0),u=o.getInt16(t+3,!0),h=o.getUint8(t+5);if(0!=n){if(c){const e=a-i,t=u-l,o=h-r;if(Math.abs(e)<32&&Math.abs(t)<32&&Math.abs(o)<4){const n=d(2);let a=128;a|=(63&e)<<1,a|=t>>5&1,n.setUint8(0,a);let i=0;i|=(31&t)<<3,i|=7&o,n.setUint8(1,i),s.push(n.buffer)}else{const e=d(6);let t=127&n;128&n&&(t|=64),e.setUint8(0,t),e.setInt16(1,a,!0),e.setInt16(3,u,!0),e.setUint8(5,h),s.push(e.buffer)}}else{const e=d(6);let t=127&n;128&n&&(t|=64),e.setUint8(0,t),e.setInt16(1,a,!0),e.setInt16(3,u,!0),e.setUint8(5,h),s.push(e.buffer),c=!0}i=a,l=u,r=h}else{const e=d(1);e.setUint8(0,0),s.push(e.buffer),c=!1}}const h=s.reduce((e,t)=>e+t.byteLength,0),m=new Uint8Array(h);let p=0;for(const e of s)m.set(new Uint8Array(e),p),p+=e.byteLength;return m.buffer}(e.rawData),n=new Blob([t],{type:"application/octet-stream"}),o=await(a=n,new Promise((e,t)=>{const n=new FileReader;n.readAsDataURL(a),n.onloadend=()=>{e(n.result.split(",")[1])},n.onerror=t}));var a;return{name:e.name,data:o}}),o={pages:await Promise.all(n),createdAt:new Date},a=Me(De,"users",Be.uid,"documents",e);await Pe(a,o),y.textContent=e,U(`Document "${e}" saved successfully.`)}catch(e){console.error("Error saving document:",e),U("Failed to save document. Please check the console for details.")}finally{v.disabled=!1,t.classList.remove("spinner")}};g.addEventListener("click",function(){const e=y.textContent,t=document.createElement("input");t.type="text",t.value=e,t.className="page-name-input",t.addEventListener("blur",()=>{const n=t.value.trim();y.textContent=n&&n!==e?n:e,t.replaceWith(y)}),t.addEventListener("keydown",n=>{"Enter"===n.key&&t.blur(),"Escape"===n.key&&(t.value=e,t.blur())}),y.replaceWith(t),t.focus(),t.select()}),w.addEventListener("click",oe),A.addEventListener("click",e=>{e.preventDefault(),oe(),x.style.display="none"}),v.addEventListener("click",Xe),I.addEventListener("click",e=>{e.preventDefault(),Xe(),x.style.display="none"}),f.addEventListener("click",()=>{const e=o.classList.contains("force-show")||window.innerWidth>768&&!o.classList.contains("force-hide");window.innerWidth>768?e?(o.classList.add("force-hide"),o.classList.remove("force-show")):o.classList.remove("force-hide"):e?o.classList.remove("force-show"):o.classList.add("force-show")}),Z(),s.style.cursor="grab"});